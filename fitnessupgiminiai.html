<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPPH - مستشارك الصحي الشامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* General Body and Layout Styles */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #1a202c, #2d3748);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #e2e8f0;
            overflow-y: auto;
        }
        .chat-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 768px;
            min-height: 95vh;
            background-color: #2d3748;
            border-radius: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid #4a5568;
            position: relative;
            margin-bottom: 20px;
        }
        .chat-header {
            background: linear-gradient(to right, #4c51bf, #3f448c);
            color: white;
            padding: 1.5rem;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }
        .chat-header-title {
            flex-basis: 100%;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            pointer-events: none;
        }
        .ai-star {
            display: inline-block;
            font-size: 3rem;
            color: #fcd34d;
            vertical-align: middle;
            margin-right: 0.5rem;
            margin-left: 0.5rem;
        }
        .chat-main-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background-color: #242b38;
            border: 2px solid #667eea;
            border-radius: 0.75rem;
            margin: 1rem;
            justify-content: flex-start;
        }

        /* Message Bubble Styles */
        .message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 1.5rem;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user {
            background-color: #4a5568;
            align-self: flex-end;
            color: #e2e8f0;
            border-bottom-right-radius: 0.5rem;
        }
        .message.ai {
            background-color: #1a202c;
            align-self: flex-start;
            color: #e2e8f0;
            border-bottom-left-radius: 0.5rem;
            position: relative;
        }
        .message-content h1, .message-content h2, .message-content h3 {
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #e2e8f0;
        }
        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.25rem; }
        .message-content h3 { font-size: 1.125rem; }
        .message-content p { margin-bottom: 0.75rem; }
        .message-content strong { color: #fcd34d; }
        .message-content a { color: #667eea; text-decoration: underline; }
        .message-content ul, .message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .message-content ul li {
            list-style-type: disc;
        }
        .message-content ol li {
            list-style-type: decimal;
        }
        .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-right: 1rem;
            color: #a0aec0;
            font-style: italic;
        }
        .message-timestamp {
            font-size: 0.7rem;
            color: #a0aec0;
            opacity: 0.7;
            margin-top: 0.25rem;
            text-align: right;
            position: absolute;
            bottom: 5px;
            right: 15px;
        }
        .message.ai .message-timestamp {
            text-align: left;
            left: 15px;
            right: auto;
        }
        .message.thinking-bubble {
            background-color: #3f448c;
            color: #e2e8f0;
            font-style: italic;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            align-self: flex-start;
            animation: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .thinking-bubble .dot {
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            animation: dotWave 1s infinite ease-in-out;
        }
        .thinking-bubble .dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-bubble .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes dotWave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-7px); }
        }
         .modal-content {
    background-color: #2d3748;
    padding: 2rem;
    border-radius: 1rem;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;    /* ارتفاع مناسب */
    overflow-y: auto;    /* التمرير العمودي */
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
    border: 1px solid #4a5568;
    position: relative;
     }
        .message.highlight-green {
            animation: highlightGreen 0.3s ease-in-out forwards;
        }
        @keyframes highlightGreen {
            0% { background-color: #1a202c; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
            50% { background-color: #38a169; box-shadow: 0 0 15px rgba(56, 161, 105, 0.7); }
            100% { background-color: #1a202c; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        }

        /* Input and Button Area Styles */
        .chat-input-area {
            display: flex;
            flex-direction: column;
            padding: 1.25rem;
            border-top: 1px solid #4a5568;
            background-color: #2d3748;
            gap: 0.75rem;
            flex-shrink: 0;
            align-items: center;
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.85rem 1.25rem;
            border: 1px solid #4a5568;
            border-radius: 2rem;
            outline: none;
            font-size: 1.05rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #1a202c;
            color: #e2e8f0;
            width: 100%;
            max-width: 100%;
        }
        .chat-input::placeholder {
            color: #a0aec0;
        }
        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            margin-top: 0.75rem;
        }
        .send-button, .stop-button, .input-action-button {
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 2rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
            flex-grow: 1;
            min-width: 120px;
        }
        .send-button:hover, .stop-button:hover, .input-action-button:hover {
            background: linear-gradient(to right, #5a67d8, #434190);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }
        .send-button:active, .stop-button:active, .input-action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        }
        .stop-button {
            background: linear-gradient(to right, #ef4444, #dc2626);
            display: none;
        }
        .stop-button:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
        }
        .disclaimer {
            text-align: center;
            font-size: 0.8rem;
            color: #a0aec0;
            padding: 1rem;
            border-top: 1px solid #4a5568;
            background-color: #2d3748;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            flex-shrink: 0;
        }

        /* Buttons and Counters */
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }
        .message-counter-area {
            text-align: center;
            font-size: 0.85rem;
            color: #a0aec0;
            padding: 0.75rem 1.25rem;
            background-color: #242b38;
            border-top: 1px solid #4a5568;
            flex-shrink: 0;
        }
        .premium-button {
            position: relative;
            overflow: hidden;
            border: 2px solid #a0aec0;
            color: #a0aec0;
            background-color: #2d3748;
            transition: border-color 0.2s, background-color 0.2s, color 0.2s;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: not-allowed;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .premium-button-active {
            border-color: #fcd34d;
            background: linear-gradient(to right, #fcd34d, #d97706);
            color: #1a202c;
            cursor: pointer;
            animation: pulse-gold 2s infinite;
        }
        .premium-button-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(252, 211, 77, 0.4);
        }

        /* Image Upload Styles */
        .image-preview-container {
            margin-top: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.75rem;
            border: 2px solid #667eea;
        }
        .remove-image-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Floating and Modal Styles */
        .floating-button-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .floating-button {
            width: 50px;
            height: 50px;
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
            border: 1px solid #4a5568;
            position: relative;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-button {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            color: #a0aec0;
            cursor: pointer;
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-input, .modal-textarea, .modal-select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            background-color: #1a202c;
            color: #e2e8f0;
            resize: vertical;
        }
        .modal-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23A0AEC0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            padding-right: 2.5rem;
        }
        .modal-save-button {
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }

        /* Notification Styles */
        .notification-card {
            background-color: #242b38;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #4a5568;
        }
        .permission-message {
            background-color: #fcd34d;
            color: #1a202c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
        }
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(252, 211, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0); }
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            body { padding: 10px; }
            .chat-wrapper { height: auto; min-height: 90vh; max-width: 98%; margin: 0 auto; }
            .chat-header { padding: 1rem; }
            .chat-header-title { font-size: 1.5rem; margin-bottom: 0; }
            .back-button { top: 10px; right: 10px; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
            .chat-messages { margin: 0.5rem; padding: 1rem; }
            .message { padding: 0.8rem 1rem; font-size: 0.9rem; }
            .chat-input-area { padding: 0.8rem; }
            .chat-input { margin-bottom: 0.5rem; }
            .button-row { flex-direction: column; gap: 0.5rem; }
            .send-button, .stop-button, .input-action-button { width: 100%; margin: 0; }
            .floating-button-container { bottom: 10px; left: 10px; }
            .floating-button { width: 45px; height: 45px; }
        }

        /* Image Message Styles */
        .image-message-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .image-message-caption {
            font-size: 0.9rem;
            color: #a0aec0;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
        }

        /* Notification repeat options */
        .repeat-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 1rem;
        }
        .repeat-day {
            padding: 5px 10px;
            border-radius: 15px;
            background-color: #2d3748;
            cursor: pointer;
            border: 1px solid #4a5568;
        }
        .repeat-day.selected {
            background-color: #667eea;
            border-color: #5a67d8;
        }
        .interval-option {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 0.5rem;
        }
        
        /* New styles for chat history */
        .chat-history-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #2d3748;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-history-item:hover {
            background-color: #3f448c;
        }
        .chat-history-date {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        /* New styles for goals system */
        .goals-floating-button {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(to right, #38a169, #2f855a);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(56, 161, 105, 0.3);
            z-index: 1000;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .goals-floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(56, 161, 105, 0.4);
        }
        .goals-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .goals-modal-content {
            background-color: #2d3748;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid #4a5568;
            position: relative;
        }
        .goal-item {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background-color: #3f448c;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .goal-complete-button {
            background-color: #38a169;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .goal-complete-button:hover {
            background-color: #2f855a;
        }
        .goal-completed {
            background-color: #2f855a;
            text-decoration: line-through;
        }
        .badge-progress {
            width: 100%;
            height: 10px;
            background-color: #4a5568;
            border-radius: 5px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .badge-progress-bar {
            height: 100%;
            background: linear-gradient(to right, #fcd34d, #d97706);
            border-radius: 5px;
            transition: width 0.3s;
        }
        .badge-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .badge-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #fcd34d;
            color: #1a202c;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .badge-locked {
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <div id="back-button" class="back-button" onclick="history.back()">
        <i class="fas fa-arrow-right"></i>
        <span>الرجوع</span>
    </div>

    <div class="chat-wrapper">
        <div class="chat-header">
            <span class="chat-header-title">SMART PPH <span class="ai-star">✦</span> 
        </div>

        <div class="chat-main-content">
            <div class="chat-messages" id="chat-messages">
                <!-- Chat messages will be appended here -->
            </div>
            
            <div id="message-counter-area" class="message-counter-area">
                الرسائل المتبقية: <span id="message-counter">3</span>
            </div>
        </div>

        <div class="chat-input-area">
            <input type="file" id="image-upload" accept="image/*" class="hidden">
            <div id="image-preview-container" class="image-preview-container hidden">
                <img id="image-preview" class="image-preview" src="" alt="Image preview">
                <button id="remove-image-button" class="remove-image-button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <input type="text" id="user-input" class="chat-input" placeholder="اكتب سؤالك عن الصحة العامة أو اللياقة البدنية هنا...">
            <div id="image-upload-warning" class="text-sm text-yellow-400 hidden">يرجى كتابة تعليق مع الصورة قبل الإرسال</div>
            <div class="button-row">
                <button id="send-button" class="send-button">
                    <i class="fas fa-paper-plane"></i> إرسال
                </button>
                <button id="image-upload-button" class="input-action-button">
                    <i class="fas fa-camera"></i> صورة
                </button>
                <button id="suggest-question-button" class="input-action-button">
                    <i class="fas fa-question-circle"></i> اقترح سؤالا
                </button>
                <button id="clear-chat-button" class="input-action-button">
                    <i class="fas fa-trash-alt"></i> مسح المحادثة
                </button>
                <button id="new-chat-button" class="input-action-button">
                    <i class="fas fa-plus"></i> محادثة جديدة
                </button>
                <button id="stop-button" class="stop-button">
                    <i class="fas fa-stop-circle"></i> إيقاف
                </button>
            </div>
        </div>
        <div class="disclaimer">
            <p>
                <i class="fas fa-exclamation-triangle"></i>
                يرجى ملاحظة أن هذه الاستشارات ليست بديلاً عن الطبيب. يجب استشارة أخصائي قبل اتخاذ أي قرارات صحية.
                <br>
                <i class="fas fa-info-circle"></i>
                ملحوظة: يجب ترك التطبيق مفتوحًا لضمان استمرارية التنبيهات.
            </p>
        </div>
    </div>

    <!-- Floating Buttons Container -->
    <div class="floating-button-container">
        <button id="notification-button" class="floating-button" title="إعداد التنبيهات">
            <i class="fas fa-bell"></i>
        </button>
        <button id="profile-button" class="floating-button" title="ملف التعريف">
            <i class="fas fa-user-circle"></i>
        </button>
        <button id="premium-button" class="floating-button" title="كود المحاولات">
            <i class="fas fa-key"></i>
        </button>
        <button id="history-button" class="floating-button" title="سجل المحادثات">
            <i class="fas fa-history"></i>
        </button>
    </div>

    <!-- Goals Modal -->
    <div id="goals-modal" class="goals-modal">
        <div class="goals-modal-content">
            <span class="close-button" id="close-goals-modal">&times;</span>
            <h2 class="modal-header">أهدافي اليومية</h2>
            
            <div class="mb-4">
                <h3 class="font-semibold mb-2">إضافة هدف جديد</h3>
                <select id="goal-type" class="modal-select">
                    <option value="water">شرب الماء</option>
                    <option value="exercise">ممارسة التمارين</option>
                    <option value="walk">المشي</option>
                    <option value="sleep">النوم الجيد</option>
                    <option value="healthy_meal">وجبة صحية</option>
                </select>
                <input type="number" id="goal-target" class="modal-input" placeholder="الهدف (مثال: 8 أكواب)" min="1">
                <button id="add-goal-button" class="modal-save-button">إضافة هدف</button>
            </div>
            
            <div class="mb-4">
                <h3 class="font-semibold mb-2">أهدافي الحالية</h3>
                <div id="current-goals">
                    <!-- Goals will be added here -->
                    <p class="text-sm text-gray-400 text-center">لا توجد أهداف حالية</p>
                </div>
            </div>
            
            <div>
                <h3 class="font-semibold mb-2">تقدمي</h3>
                <div class="badge-progress">
                    <div id="badge-progress-bar" class="badge-progress-bar" style="width: 0%"></div>
                </div>
                
                <div class="mt-4">
                    <div class="badge-item">
                        <div class="badge-icon"><i class="fas fa-couch"></i></div>
                        <span>كنبة البطاطا</span>
                    </div>
                    <div class="badge-item">
                        <div class="badge-icon"><i class="fas fa-walking"></i></div>
                        <span>المبتدئ</span>
                    </div>
                    <div class="badge-item">
                        <div class="badge-icon"><i class="fas fa-fire"></i></div>
                        <span>نشيط</span>
                    </div>
                    <div class="badge-item">
                        <div class="badge-icon"><i class="fas fa-medal"></i></div>
                        <span>بطل اللياقة</span>
                    </div>
                    <div class="badge-item">
                        <div class="badge-icon"><i class="fas fa-award"></i></div>
                        <span>Aura Body</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Notifications, Profile, and Premium Code -->
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-notification-modal">&times;</span>
            <h2 class="modal-header">إعداد التنبيهات</h2>
            <div class="notification-card">
                <p class="font-semibold mb-2">أضف تنبيهًا جديدًا</p>
                <input type="text" id="notification-title-input" class="modal-input" placeholder="عنوان التنبيه (مثلاً: تذكير بشرب الماء)">
                <input type="time" id="notification-time-input" class="modal-input">
                
                <div class="mb-3">
                    <label class="block text-right mb-2">نوع التكرار:</label>
                    <select id="notification-repeat-type" class="modal-select">
                        <option value="daily">يومي</option>
                        <option value="weekly">أسبوعي</option>
                        <option value="interval">كل فترة زمنية</option>
                    </select>
                </div>
                
                <div id="weekly-options" class="hidden">
                    <label class="block text-right mb-2">أيام الأسبوع:</label>
                    <div class="repeat-options">
                        <div class="repeat-day" data-day="0">الأحد</div>
                        <div class="repeat-day" data-day="1">الإثنين</div>
                        <div class="repeat-day" data-day="2">الثلاثاء</div>
                        <div class="repeat-day" data-day="3">الأربعاء</div>
                        <div class="repeat-day" data-day="4">الخميس</div>
                        <div class="repeat-day" data-day="5">الجمعة</div>
                        <div class="repeat-day" data-day="6">السبت</div>
                    </div>
                </div>
                
                <div id="interval-options" class="hidden">
                    <label class="block text-right mb-2">كل:</label>
                    <div class="interval-option">
                        <input type="number" id="interval-value" class="modal-input" min="1" max="1440" value="60" style="width: 80px;">
                        <select id="interval-unit" class="modal-select">
                            <option value="minutes">دقائق</option>
                            <option value="hours">ساعات</option>
                        </select>
                    </div>
                </div>
                
                <button id="add-notification-button" class="modal-save-button">إضافة تنبيه</button>
            </div>
            <div class="notification-card">
                <p class="font-semibold mb-2">التنبيهات المجدولة</p>
                <div id="scheduled-notifications">
                    <!-- Scheduled notifications will be displayed here -->
                    <p class="text-sm text-gray-400">لا توجد تنبيهات مجدولة حاليًا.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-profile-modal">&times;</span>
            <h2 class="modal-header">ملف التعريف</h2>
            <input type="text" id="profile-name-input" class="modal-input" placeholder="اسمك">
            
            <div class="mb-3">
                <label class="block text-right mb-2">الجنس:</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="gender" value="male" class="mr-2"> ذكر
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="gender" value="female" class="mr-2"> أنثى
                    </label>
                </div>
            </div>
            
            <textarea id="profile-info-input" class="modal-input" placeholder="معلومات عنك (العمر، الوزن، الطول، الحالة الصحية، الأهداف الرياضية...)"></textarea>
            <button id="save-profile-button" class="modal-save-button">حفظ</button>
        </div>
    </div>

    <div id="premium-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-premium-modal">&times;</span>
            <h2 class="modal-header">كود المحاولات اللانهائية</h2>
            <p class="text-sm text-center text-gray-400 mb-4">أدخل الكود السري للحصول على محاولات غير محدودة.</p>
            <input type="password" id="premium-code-input" class="modal-input" placeholder="أدخل الكود هنا">
            <p id="premium-message" class="text-sm text-center text-red-500 mb-2"></p>
            <button id="activate-premium-button" class="modal-save-button">تفعيل</button>
        </div>
    </div>
    
    <!-- Chat History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-history-modal">&times;</span>
            <h2 class="modal-header">سجل المحادثات</h2>
            <div id="chat-history-list" class="max-h-[60vh] overflow-y-auto">
                <!-- Chat history items will be appended here -->
                <p class="text-sm text-gray-400 text-center">لا توجد محادثات مسجلة بعد.</p>
            </div>
        </div>
    </div>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        marked.setOptions({
            breaks: true,
            gfm: true,
        });
    </script>
    <!-- My JavaScript -->
    <script type="module">
        // Constants for storage keys
        const CHAT_HISTORY_KEY = 'chatHistory';
        const CHAT_SESSIONS_KEY = 'chatSessions';
        const NOTIFICATIONS_KEY = 'notifications';
        const MESSAGE_COUNTER_KEY = 'messageCounter';
        const MESSAGE_DATE_KEY = 'messageDate';
        const PREMIUM_STATUS_KEY = 'premiumStatus';
        const PROFILE_KEY = 'userProfile';
        const GOALS_KEY = 'userGoals';
        const BADGES_KEY = 'userBadges';
        const MAX_FREE_MESSAGES = 3;
        const PREMIUM_CODE = 'Az700200';

        // Fix: Use an empty API key and let the Canvas environment handle it
        const apiKey = "AIzaSyBl6P09eSlQ8lOxqG8tjc9gU-rlBFHGSXk"; // تم تغيير هذا السطر ليصبح مفتاح API فارغًا
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;
        
        // DOM Elements
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const stopButton = document.getElementById('stop-button');
        const chatMessages = document.getElementById('chat-messages');
        const imageUploadButton = document.getElementById('image-upload-button');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageButton = document.getElementById('remove-image-button');
        const suggestQuestionButton = document.getElementById('suggest-question-button');
        const clearChatButton = document.getElementById('clear-chat-button');
        const newChatButton = document.getElementById('new-chat-button');
        const notificationButton = document.getElementById('notification-button');
        const notificationModal = document.getElementById('notification-modal');
        const closeNotificationModal = document.getElementById('close-notification-modal');
        const addNotificationButton = document.getElementById('add-notification-button');
        const notificationTitleInput = document.getElementById('notification-title-input');
        const notificationTimeInput = document.getElementById('notification-time-input');
        const scheduledNotificationsDiv = document.getElementById('scheduled-notifications');
        const messageCounterSpan = document.getElementById('message-counter');
        const profileButton = document.getElementById('profile-button');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModal = document.getElementById('close-profile-modal');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileInfoInput = document.getElementById('profile-info-input');
        const saveProfileButton = document.getElementById('save-profile-button');
        const premiumButton = document.getElementById('premium-button');
        const premiumModal = document.getElementById('premium-modal');
        const closePremiumModal = document.getElementById('close-premium-modal');
        const premiumCodeInput = document.getElementById('premium-code-input');
        const premiumMessage = document.getElementById('premium-message');
        const activatePremiumButton = document.getElementById('activate-premium-button');
        const imageUploadWarning = document.getElementById('image-upload-warning');
        const notificationRepeatType = document.getElementById('notification-repeat-type');
        const weeklyOptions = document.getElementById('weekly-options');
        const intervalOptions = document.getElementById('interval-options');
        const historyButton = document.getElementById('history-button');
        const historyModal = document.getElementById('history-modal');
        const closeHistoryModal = document.getElementById('close-history-modal');
        const chatHistoryList = document.getElementById('chat-history-list');
        const goalsButton = document.getElementById('goals-button');
        const goalsModal = document.getElementById('goals-modal');
        const closeGoalsModal = document.getElementById('close-goals-modal');
        const goalTypeSelect = document.getElementById('goal-type');
        const goalTargetInput = document.getElementById('goal-target');
        const addGoalButton = document.getElementById('add-goal-button');
        const currentGoalsDiv = document.getElementById('current-goals');
        const badgeProgressBar = document.getElementById('badge-progress-bar');

        // State Variables
        let chatHistory = [];
        let chatSessions = [];
        let currentSessionId = null;
        let imageToUpload = null;
        let isWaitingForResponse = false;
        let messageCounter = 0;
        let unlimitedMessages = false;
        let timeCounterInterval = null;
        let goals = [];
        let badgesProgress = 0;
        let healthTipsInterval = null;

        // Health tips
        const healthTips = [
            "💧 لا تنسى شرب الماء! يحتاج الجسم إلى 8 أكواب يومياً على الأقل.",
            "🏃‍♂️ جرب المشي لمدة 30 دقيقة يومياً لتحسين صحتك العامة.",
            "🍎 تناول الفواكه والخضروات الطازجة لتعزيز مناعتك.",
            "😴 احرص على النوم 7-8 ساعات يومياً لاستعادة نشاطك.",
            "🧘‍♀️ خصص 10 دقائق يومياً للتمارين التنفسية لتقليل التوتر.",
            "🚭 تجنب التدخين فهو يضر بالرئتين والقلب.",
            "🧂 قلل من تناول الملح لتجنب ارتفاع ضغط الدم.",
            "☀️ احصل على 15 دقيقة من أشعة الشمس يومياً لفيتامين د.",
            "📱 خذ استراحة من الشاشات كل ساعة لحماية عينيك.",
            "🍽️ تناول وجبات صغيرة متعددة بدلاً من وجبات كبيرة."
        ];

        // Badges system
        const badges = [
            { id: 1, name: "كنبة البطاطا", icon: "fa-couch", minProgress: 0 },
            { id: 2, name: "المبتدئ", icon: "fa-walking", minProgress: 20 },
            { id: 3, name: "نشيط", icon: "fa-fire", minProgress: 40 },
            { id: 4, name: "بطل اللياقة", icon: "fa-medal", minProgress: 60 },
            { id: 5, name: "Aura Body", icon: "fa-award", minProgress: 80 }
        ];

        // ---- Storage Functions ----
        function saveChatHistory() {
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatHistory));
            
            // Update current session in chatSessions
            if (currentSessionId) {
                const sessionIndex = chatSessions.findIndex(session => session.id === currentSessionId);
                if (sessionIndex !== -1) {
                    chatSessions[sessionIndex].lastMessage = chatHistory[chatHistory.length - 1]?.parts[0]?.text || "بدون رسائل";
                    chatSessions[sessionIndex].updatedAt = new Date().toISOString();
                }
                localStorage.setItem(CHAT_SESSIONS_KEY, JSON.stringify(chatSessions));
            }
        }

        function loadChatHistory() {
            const savedChat = localStorage.getItem(CHAT_HISTORY_KEY);
            if (savedChat) {
                chatHistory = JSON.parse(savedChat);
                chatHistory.forEach(message => {
                    if (message.role === 'user' && message.imageUrl) {
                        displayImageMessage(message.parts[0].text, message.imageUrl);
                    } else {
                        displayMessage(message.role, message.parts[0].text);
                    }
                });
            }
            
            // Load chat sessions
            const savedSessions = localStorage.getItem(CHAT_SESSIONS_KEY);
            if (savedSessions) {
                chatSessions = JSON.parse(savedSessions);
            }
        }
        
        function saveProfile() {
            const gender = document.querySelector('input[name="gender"]:checked')?.value || 'male';
            const profile = {
                name: profileNameInput.value,
                gender: gender,
                info: profileInfoInput.value
            };
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
            return profile;
        }

        function loadProfile() {
            const savedProfile = localStorage.getItem(PROFILE_KEY);
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                profileNameInput.value = profile.name;
                profileInfoInput.value = profile.info;
                
                // Set gender radio button
                if (profile.gender) {
                    document.querySelector(`input[name="gender"][value="${profile.gender}"]`).checked = true;
                }
                
                return profile;
            }
            return null;
        }

        function saveMessageCounter() {
            localStorage.setItem(MESSAGE_COUNTER_KEY, messageCounter);
            localStorage.setItem(MESSAGE_DATE_KEY, new Date().toDateString());
        }

        function loadMessageCounter() {
            const savedCounter = localStorage.getItem(MESSAGE_COUNTER_KEY);
            const savedDate = localStorage.getItem(MESSAGE_DATE_KEY);
            const today = new Date().toDateString();

            if (savedCounter && savedDate === today) {
                messageCounter = parseInt(savedCounter, 10);
            } else {
                messageCounter = 0;
                localStorage.removeItem(MESSAGE_COUNTER_KEY);
                localStorage.removeItem(MESSAGE_DATE_KEY);
            }
        }
        
        function updateMessageCounter() {
            loadMessageCounter();
            
            if (timeCounterInterval) {
                clearInterval(timeCounterInterval);
            }
            
            if (unlimitedMessages) {
                messageCounterSpan.textContent = "غير محدود";
            } else {
                const remaining = MAX_FREE_MESSAGES - messageCounter;
                if (remaining > 0) {
                    messageCounterSpan.textContent = remaining;
                } else {
                    const updateCounter = () => {
                        const now = new Date();
                        const midnight = new Date();
                        midnight.setHours(24, 0, 0, 0);
                        const diff = midnight.getTime() - now.getTime();
                        
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        messageCounterSpan.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    };
                    
                    updateCounter();
                    timeCounterInterval = setInterval(updateCounter, 1000);
                }
            }
        }
        
        // ---- Goals System Functions ----
        function saveGoals() {
            localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
        }

        function loadGoals() {
            const savedGoals = localStorage.getItem(GOALS_KEY);
            goals = savedGoals ? JSON.parse(savedGoals) : [];
            renderGoals();
        }

        function saveBadgesProgress() {
            localStorage.setItem(BADGES_KEY, JSON.stringify(badgesProgress));
        }

        function loadBadgesProgress() {
            const savedProgress = localStorage.getItem(BADGES_KEY);
            badgesProgress = savedProgress ? parseInt(savedProgress) : 0;
            updateBadgesProgress();
        }

        function addGoal(type, target) {
            const goal = {
                id: Date.now(),
                type: type,
                target: target,
                completed: 0,
                createdAt: new Date().toISOString()
            };
            goals.push(goal);
            saveGoals();
            renderGoals();
        }

        function completeGoal(goalId) {
            const goalIndex = goals.findIndex(g => g.id === goalId);
            if (goalIndex !== -1) {
                goals[goalIndex].completed += 1;
                
                // Update badges progress
                badgesProgress += 5;
                if (badgesProgress > 100) badgesProgress = 100;
                saveBadgesProgress();
                updateBadgesProgress();
                
                saveGoals();
                renderGoals();
            }
        }

        function deleteGoal(goalId) {
            goals = goals.filter(g => g.id !== goalId);
            saveGoals();
            renderGoals();
        }

        function renderGoals() {
            currentGoalsDiv.innerHTML = '';
            
            if (goals.length === 0) {
                currentGoalsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center">لا توجد أهداف حالية</p>';
                return;
            }
            
            goals.forEach(goal => {
                const goalItem = document.createElement('div');
                goalItem.className = 'goal-item';
                if (goal.completed >= goal.target) {
                    goalItem.classList.add('goal-completed');
                }
                
                const goalName = getGoalName(goal.type);
                const goalIcon = getGoalIcon(goal.type);
                
                goalItem.innerHTML = `
                    <div>
                        <div class="flex items-center gap-2">
                            <i class="fas ${goalIcon}"></i>
                            <span>${goalName} (${goal.completed}/${goal.target})</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button class="goal-complete-button" data-id="${goal.id}">إكمال</button>
                            <button class="goal-complete-button" style="background-color: #ef4444;" data-id="${goal.id}" data-action="delete">حذف</button>
                        </div>
                    </div>
                `;
                
                currentGoalsDiv.appendChild(goalItem);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.goal-complete-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const goalId = parseInt(button.dataset.id);
                    if (button.dataset.action === 'delete') {
                        deleteGoal(goalId);
                    } else {
                        completeGoal(goalId);
                    }
                });
            });
        }

        function getGoalName(type) {
            const names = {
                water: 'شرب الماء',
                exercise: 'ممارسة التمارين',
                walk: 'المشي',
                sleep: 'النوم الجيد',
                healthy_meal: 'وجبة صحية'
            };
            return names[type] || type;
        }

        function getGoalIcon(type) {
            const icons = {
                water: 'fa-tint',
                exercise: 'fa-dumbbell',
                walk: 'fa-walking',
                sleep: 'fa-bed',
                healthy_meal: 'fa-apple-alt'
            };
            return icons[type] || 'fa-bullseye';
        }

        function updateBadgesProgress() {
            badgeProgressBar.style.width = `${badgesProgress}%`;
            
            // Update badges display
            document.querySelectorAll('.badge-item').forEach((item, index) => {
                if (badgesProgress >= badges[index].minProgress) {
                    item.classList.remove('badge-locked');
                } else {
                    item.classList.add('badge-locked');
                }
            });
        }

        // ---- Health Tips Notifications ----
        function setupHealthTips() {
            // Clear any existing interval
            if (healthTipsInterval) {
                clearInterval(healthTipsInterval);
            }
            
            // Send first tip immediately
            sendHealthTip();
            
            // Set interval for every 12 hours
            healthTipsInterval = setInterval(sendHealthTip, 12 * 60 * 60 * 1000);
        }

        function sendHealthTip() {
            const randomTip = healthTips[Math.floor(Math.random() * healthTips.length)];
            
            if (Notification.permission === "granted") {
                new Notification("نصيحة صحية من SmartPPH", {
                    body: randomTip,
                    icon: 'https://placehold.co/64x64/4c51bf/ffffff?text=FP',
                    vibrate: [200, 100, 200]
                });
            }
            
            // Also display in chat if app is open
            displayMessage('ai', `💡 نصيحة صحية: ${randomTip}`);
        }

        // ---- UI Functions ----
        function displayMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            
            const profile = JSON.parse(localStorage.getItem(PROFILE_KEY)) || {};
            if (role === 'ai' && profile.name) {
                text = text.replace(/مرحباً بك/gi, `مرحباً ${profile.name}`);
                text = text.replace(/أهلاً بك/gi, `أهلاً ${profile.name}`);
            }
            
            contentDiv.innerHTML = marked.parse(text);

            const timestampDiv = document.createElement('div');
            timestampDiv.classList.add('message-timestamp');
            timestampDiv.textContent = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timestampDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayImageMessage(caption, imageUrl) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'user');
            
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-message-container');
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '200px';
            img.style.borderRadius = '0.75rem';
            img.style.border = '2px solid #667eea';
            
            const captionDiv = document.createElement('div');
            captionDiv.classList.add('image-message-caption');
            captionDiv.textContent = caption;
            
            imageContainer.appendChild(img);
            imageContainer.appendChild(captionDiv);
            
            const timestampDiv = document.createElement('div');
            timestampDiv.classList.add('message-timestamp');
            timestampDiv.textContent = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.appendChild(imageContainer);
            messageDiv.appendChild(timestampDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayThinkingBubble() {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.classList.add('message', 'thinking-bubble', 'ai');
            thinkingDiv.id = 'thinking-bubble';
            thinkingDiv.innerHTML = `
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            `;
            chatMessages.appendChild(thinkingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeThinkingBubble() {
            const thinkingDiv = document.getElementById('thinking-bubble');
            if (thinkingDiv) {
                thinkingDiv.remove();
            }
        }

        // ---- API Call Functions ----
        async function fetchGeminiResponse(prompt, imageBase64 = null) {
            if (!unlimitedMessages && messageCounter >= MAX_FREE_MESSAGES) {
                const timeRemaining = getTimeUntilMidnight();
                const responseText = `انتهت المحاولات اليومية. عد بعد (${timeRemaining}).`;
                displayMessage('ai', responseText);
                return;
            }

            isWaitingForResponse = true;
            sendButton.disabled = true;
            stopButton.style.display = 'flex';
            displayThinkingBubble();

            const contents = [];
            
            chatHistory.forEach(msg => {
                if (msg.role === "user" || msg.role === "model") {
                    contents.push(msg);
                }
            });

            const newUserMessage = {
                role: 'user',
                parts: [{ text: prompt }]
            };
            if (imageBase64) {
                newUserMessage.imageUrl = imagePreview.src;
            }
            contents.push(newUserMessage);

            const profile = JSON.parse(localStorage.getItem(PROFILE_KEY)) || {};
            
            const systemInstruction = {
                role: "model",
                parts: [{
                    text: `بصفتك مستشاراً طبياً ورياضياً ودوداً ومرحاً ومشجعاً، 
                    اجب على الرسالة التالية من غير إطالة ومن غير اختصار شديد، 
                    مستخدماً الوجوه التعبيرية لكن بعدد قليل، وحاول أن تمزج بين اللغة العربية الفصحى واللهجة المصرية إلا إذا طُلب منك غير ذلك.
                    ${profile.name ? `اسم المستخدم: ${profile.name}` : ''}
                    ${profile.gender ? `جنس المستخدم: ${profile.gender === 'male' ? 'ذكر' : 'أنثى'}` : ''}
                    ${profile.info ? `المعلومات التي أعطاها المستخدم عن نفسه: ${profile.info}` : ''}
                    تم برمجتك بواسطة SmartPharmacy وانت شات بوت اسمه FitAI داخل تطبيق اسمه SmartPPH
                    إذا تحدث المستخدم في شيء غير الرياضة والصحة، حاول الإجابة على طلبه وفي النهاية اربط بين الصحة وطلبه.`
                }]
            };

            const payload = {
                contents: contents,
                systemInstruction: systemInstruction
            };

            let responseText = "";
            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Too many requests. Retrying...');
                        }
                        const error = await response.json();
                        throw new Error(error.error.message || 'Network response was not ok');
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        responseText = result.candidates[0].content.parts[0].text;
                    } else {
                        responseText = "عذرًا، لم أتمكن من الحصول على رد. الرجاء المحاولة مرة أخرى.";
                    }
                    
                    break;

                } catch (error) {
                    console.error('API call failed:', error);
                    retries--;
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        responseText = "عذرًا، واجهت مشكلة في الاتصال. الرجاء المحاولة لاحقًا.";
                    }
                }
            }

            removeThinkingBubble();
            displayMessage('ai', responseText);

            chatHistory.push(newUserMessage);
            chatHistory.push({ role: "model", parts: [{ text: responseText }] });
            saveChatHistory();
            
            if (!unlimitedMessages) {
                messageCounter++;
                saveMessageCounter();
                updateMessageCounter();
            }

            isWaitingForResponse = false;
            sendButton.disabled = false;
            stopButton.style.display = 'none';
            return responseText;
        }

        function getTimeUntilMidnight() {
            const now = new Date();
            const midnight = new Date();
            midnight.setHours(24, 0, 0, 0);
            const diff = midnight.getTime() - now.getTime();
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours} ساعة و ${minutes} دقيقة`;
        }

        // ---- Notification Functions ----
        function saveNotifications(notifications) {
            localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(notifications));
        }

        function loadNotifications() {
            const savedNotifications = localStorage.getItem(NOTIFICATIONS_KEY);
            return savedNotifications ? JSON.parse(savedNotifications) : [];
        }

        function setupNotifications() {
            if (!("Notification" in window)) {
                console.warn("This browser does not support desktop notification");
            } else if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }

            const notifications = loadNotifications();
            notifications.forEach(notification => {
                scheduleNotification(notification);
            });
            renderScheduledNotifications();
        }

        function scheduleNotification(notification) {
            if (notification.repeatType === 'interval') {
                scheduleIntervalNotification(notification);
                return;
            }

            const [hours, minutes] = notification.time.split(':').map(Number);
            
            const now = new Date();
            let scheduledTime = new Date();
            scheduledTime.setHours(hours, minutes, 0, 0);

            if (scheduledTime < now) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }

            const delay = scheduledTime.getTime() - now.getTime();
            
            setTimeout(() => {
                if (Notification.permission === "granted") {
                    new Notification("SmartPPH", {
                        body: notification.title,
                        icon: 'https://placehold.co/64x64/4c51bf/ffffff?text=FP',
                        vibrate: [200, 100, 200]
                    });
                }

                // Reschedule based on repeat type
                if (notification.repeatType === 'daily') {
                    scheduleNotification(notification);
                } else if (notification.repeatType === 'weekly') {
                    const today = new Date().getDay();
                    if (notification.days.includes(today.toString())) {
                        scheduleNotification(notification);
                    } else {
                        // Find next day in the week
                        let nextDay = null;
                        for (let i = 1; i <= 7; i++) {
                            const checkDay = (today + i) % 7;
                            if (notification.days.includes(checkDay.toString())) {
                                nextDay = i;
                                break;
                            }
                        }
                        
                        if (nextDay !== null) {
                            setTimeout(() => {
                                scheduleNotification(notification);
                            }, nextDay * 24 * 60 * 60 * 1000);
                        }
                    }
                }
            }, delay);
        }

        function scheduleIntervalNotification(notification) {
            const interval = notification.intervalValue * (notification.intervalUnit === 'minutes' ? 60 * 1000 : 60 * 60 * 1000);
            
            const timer = setInterval(() => {
                if (Notification.permission === "granted") {
                    new Notification("SmartPPH", {
                        body: notification.title,
                        icon: 'https://placehold.co/64x64/4c51bf/ffffff?text=FP',
                        vibrate: [200, 100, 200]
                    });
                }
            }, interval);

            // Store timer ID to allow cancellation
            notification.timerId = timer;
        }

        function renderScheduledNotifications() {
            const notifications = loadNotifications();
            scheduledNotificationsDiv.innerHTML = '';
            if (notifications.length === 0) {
                scheduledNotificationsDiv.innerHTML = '<p class="text-sm text-gray-400">لا توجد تنبيهات مجدولة حاليًا.</p>';
                return;
            }
            notifications.forEach((notification, index) => {
                const notificationItem = document.createElement('div');
                notificationItem.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'border-b', 'border-gray-600', 'last:border-b-0');
                
                let details = '';
                if (notification.repeatType === 'daily') {
                    details = `يوميًا في ${notification.time}`;
                } else if (notification.repeatType === 'weekly') {
                    const daysMap = { '0': 'الأحد', '1': 'الإثنين', '2': 'الثلاثاء', '3': 'الأربعاء', 
                                    '4': 'الخميس', '5': 'الجمعة', '6': 'السبت' };
                    const daysText = notification.days.map(day => daysMap[day]).join('، ');
                    details = `أسبوعيًا أيام ${daysText} في ${notification.time}`;
                } else if (notification.repeatType === 'interval') {
                    details = `كل ${notification.intervalValue} ${notification.intervalUnit === 'minutes' ? 'دقائق' : 'ساعات'}`;
                }
                
                notificationItem.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-medium">${notification.title}</p>
                        <p class="text-sm text-gray-400">${details}</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700 transition-colors" data-index="${index}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                scheduledNotificationsDiv.appendChild(notificationItem);
            });
        }
        
        scheduledNotificationsDiv.addEventListener('click', (e) => {
            if (e.target.closest('button')) {
                const index = e.target.closest('button').dataset.index;
                let notifications = loadNotifications();
                
                // Clear interval if it's an interval notification
                if (notifications[index].timerId) {
                    clearInterval(notifications[index].timerId);
                }
                
                notifications.splice(index, 1);
                saveNotifications(notifications);
                renderScheduledNotifications();
            }
        });

        // ---- Chat History Functions ----
        function renderChatHistory() {
            chatHistoryList.innerHTML = '';
            
            if (chatSessions.length === 0) {
                chatHistoryList.innerHTML = '<p class="text-sm text-gray-400 text-center">لا توجد محادثات مسجلة بعد.</p>';
                return;
            }
            
            // Sort sessions by date (newest first)
            const sortedSessions = [...chatSessions].sort((a, b) => 
                new Date(b.updatedAt) - new Date(a.updatedAt));
            
            sortedSessions.forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.classList.add('chat-history-item');
                sessionItem.dataset.sessionId = session.id;
                
                const date = new Date(session.updatedAt);
                const dateStr = date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // تحديد الرسالة المعروضة (الرسالة الثانية إذا كانت موجودة)
                let displayMessage = 'بدون رسائل';
                if (session.messages && session.messages.length > 1) {
                    // نأخذ أول رسالة من المستخدم (تخطي رسالة الترحيب الأولى)
                    const userMessages = session.messages.filter(msg => msg.role === 'user');
                    if (userMessages.length > 0) {
                        displayMessage = userMessages[0].parts[0].text;
                    } else if (session.messages.length > 1) {
                        displayMessage = session.messages[1].parts[0].text;
                    }
                }
                
                sessionItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p>${session.title || 'محادثة جديدة'}</p>
                        <span class="chat-history-date">${dateStr}</span>
                    </div>
                    <p class="text-sm text-gray-400 truncate">${displayMessage}</p>
                `;
                
                sessionItem.addEventListener('click', () => {
                    loadChatSession(session.id);
                    closeHistoryModal.click();
                });
                
                chatHistoryList.appendChild(sessionItem);
            });
        }

        function loadChatSession(sessionId) {
            const session = chatSessions.find(s => s.id === sessionId);
            if (session) {
                currentSessionId = sessionId;
                chatHistory = session.messages || [];
                chatMessages.innerHTML = '';
                
                chatHistory.forEach(message => {
                    if (message.role === 'user' && message.imageUrl) {
                        displayImageMessage(message.parts[0].text, message.imageUrl);
                    } else {
                        displayMessage(message.role, message.parts[0].text);
                    }
                });
                
                if (chatHistory.length === 0) {
                    const welcomeMessage = 'مرحباً بك في SmartPPH! أنا **مستشارك الشخصي في الصحة العامة واللياقة البدنية**. يسعدني أن أقدم لك استشارات طبية ونصائح صحية ورياضية لمساعدتك في تحقيق أهدافك. كيف يمكنني مساعدتك اليوم؟';
                    displayMessage('ai', welcomeMessage);
                    chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
                    saveChatHistory();
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        function createNewChatSession() {
            const sessionId = Date.now().toString();
            const newSession = {
                id: sessionId,
                title: 'محادثة جديدة',
                lastMessage: '',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            chatSessions.push(newSession);
            localStorage.setItem(CHAT_SESSIONS_KEY, JSON.stringify(chatSessions));
            
            currentSessionId = sessionId;
            chatHistory = [];
            chatMessages.innerHTML = '';
            
            const welcomeMessage = 'مرحباً بك في SmartPPH! أنا **مستشارك الشخصي في الصحة العامة واللياقة البدنية**. يسعدني أن أقدم لك استشارات طبية ونصائح صحية ورياضية لمساعدتك في تحقيق أهدافك. كيف يمكنني مساعدتك اليوم؟';
            displayMessage('ai', welcomeMessage);
            chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
            saveChatHistory();
            
            return sessionId;
        }

        // ---- Event Listeners ----
        sendButton.addEventListener('click', () => {
            const prompt = userInput.value.trim();
            
            if (imageToUpload && !prompt) {
                imageUploadWarning.classList.remove('hidden');
                return;
            } else {
                imageUploadWarning.classList.add('hidden');
            }
            
            if ((prompt !== '' || imageToUpload) && !isWaitingForResponse) {
                if (imageToUpload) {
                    displayImageMessage(prompt || "صورة بدون تعليق", imagePreview.src);
                } else {
                    displayMessage('user', prompt);
                }
                
                userInput.value = '';
                const imageBase64 = imageToUpload ? imagePreview.src.split(',')[1] : null;
                fetchGeminiResponse(prompt || "يرجى تحليل هذه الصورة", imageBase64);
                imageToUpload = null;
                imagePreviewContainer.classList.add('hidden');
                imagePreview.src = '';
            }
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isWaitingForResponse) {
                sendButton.click();
            }
        });

        stopButton.addEventListener('click', () => {
            removeThinkingBubble();
            isWaitingForResponse = false;
            sendButton.disabled = false;
            stopButton.style.display = 'none';
        });

        imageUploadButton.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToUpload = file;
                    imagePreview.src = event.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    
                    if (!userInput.value.trim()) {
                        imageUploadWarning.classList.remove('hidden');
                    } else {
                        imageUploadWarning.classList.add('hidden');
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageButton.addEventListener('click', () => {
            imageToUpload = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            imageUpload.value = '';
            imageUploadWarning.classList.add('hidden');
        });

        suggestQuestionButton.addEventListener('click', () => {
            if (isWaitingForResponse) return;
            const suggestions = [
                'ما هو أفضل نظام غذائي لزيادة الكتلة العضلية؟',
                'كيف يمكنني أن أحرق الدهون بشكل أسرع؟',
                'ما هي التمارين الرياضية المناسبة للمبتدئين؟',
                'هل يمكن أن تعطيني خطة تدريبية لمدة أسبوع؟',
                'ما أهمية شرب الماء أثناء التمرين؟',
                'ما هي أعراض نقص فيتامين د؟',
                'كيف أتعامل مع ارتفاع ضغط الدم؟',
                'ما هي أفضل الأطعمة لصحة القلب؟',
                'كيف يمكنني تحسين جودة نومي؟',
                'ما هي طرق الوقاية من نزلات البرد؟'
            ];
            const randomQuestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            userInput.value = randomQuestion;
            imageUploadWarning.classList.add('hidden');
        });

        clearChatButton.addEventListener('click', () => {
            chatHistory = [];
            saveChatHistory();
            chatMessages.innerHTML = '';
            
            const welcomeMessage = 'مرحباً بك في SmartPPH! أنا **مستشارك الشخصي في الصحة العامة واللياقة البدنية**. يسعدني أن أقدم لك استشارات طبية ونصائح صحية ورياضية لمساعدتك في تحقيق أهدافك. كيف يمكنني مساعدتك اليوم؟';
            displayMessage('ai', welcomeMessage);
            chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
            saveChatHistory();
        });
        
        newChatButton.addEventListener('click', () => {
            createNewChatSession();
        });

        // Notification Modal Listeners
        notificationButton.addEventListener('click', () => {
            notificationModal.style.display = 'flex';
            notificationModal.style.opacity = '1';
        });

        closeNotificationModal.addEventListener('click', () => {
            notificationModal.style.opacity = '0';
            setTimeout(() => {
                notificationModal.style.display = 'none';
            }, 300);
        });

        // Handle repeat type changes
        notificationRepeatType.addEventListener('change', () => {
            weeklyOptions.classList.add('hidden');
            intervalOptions.classList.add('hidden');
            
            if (notificationRepeatType.value === 'weekly') {
                weeklyOptions.classList.remove('hidden');
            } else if (notificationRepeatType.value === 'interval') {
                intervalOptions.classList.remove('hidden');
            }
        });

        // Handle day selection
        weeklyOptions.addEventListener('click', (e) => {
            if (e.target.classList.contains('repeat-day')) {
                e.target.classList.toggle('selected');
            }
        });

        addNotificationButton.addEventListener('click', () => {
            const title = notificationTitleInput.value.trim();
            const time = notificationTimeInput.value;
            const repeatType = notificationRepeatType.value;

            if (title && (time || repeatType === 'interval')) {
                const notification = {
                    title: title,
                    repeatType: repeatType
                };

                if (repeatType === 'daily' || repeatType === 'weekly') {
                    if (!time) {
                        console.error('الرجاء تحديد وقت التنبيه');
                        return;
                    }
                    notification.time = time;
                }

                if (repeatType === 'weekly') {
                    const selectedDays = Array.from(weeklyOptions.querySelectorAll('.repeat-day.selected'))
                                            .map(day => day.dataset.day);
                    if (selectedDays.length === 0) {
                        console.error('الرجاء تحديد يوم واحد على الأقل');
                        return;
                    }
                    notification.days = selectedDays;
                } else if (repeatType === 'interval') {
                    const intervalValue = parseInt(document.getElementById('interval-value').value);
                    const intervalUnit = document.getElementById('interval-unit').value;
                    
                    if (isNaN(intervalValue) || intervalValue < 1) {
                        console.error('الرجاء إدخال قيمة صحيحة للفترة الزمنية');
                        return;
                    }
                    
                    notification.intervalValue = intervalValue;
                    notification.intervalUnit = intervalUnit;
                }

                const notifications = loadNotifications();
                notifications.push(notification);
                saveNotifications(notifications);
                setupNotifications();
                renderScheduledNotifications();
                
                notificationTitleInput.value = '';
                notificationTimeInput.value = '';
                weeklyOptions.querySelectorAll('.repeat-day').forEach(day => day.classList.remove('selected'));
            }
        });
        
        // Profile Modal Listeners
        profileButton.addEventListener('click', () => {
            loadProfile();
            profileModal.style.display = 'flex';
            profileModal.style.opacity = '1';
        });

        closeProfileModal.addEventListener('click', () => {
            profileModal.style.opacity = '0';
            setTimeout(() => {
                profileModal.style.display = 'none';
            }, 300);
        });

        saveProfileButton.addEventListener('click', () => {
            saveProfile();
            closeProfileModal.click();
        });

        // Premium Modal Listeners
        premiumButton.addEventListener('click', () => {
            premiumCodeInput.value = '';
            premiumMessage.textContent = '';
            premiumModal.style.display = 'flex';
            premiumModal.style.opacity = '1';
        });

        closePremiumModal.addEventListener('click', () => {
            premiumModal.style.opacity = '0';
            setTimeout(() => {
                premiumModal.style.display = 'none';
            }, 300);
        });

        activatePremiumButton.addEventListener('click', () => {
            if (premiumCodeInput.value === PREMIUM_CODE) {
                localStorage.setItem(PREMIUM_STATUS_KEY, 'true');
                unlimitedMessages = true;
                premiumMessage.textContent = 'تم تفعيل المحاولات اللانهائية بنجاح!';
                premiumMessage.style.color = '#38a169';
                updateMessageCounter();
                setTimeout(() => closePremiumModal.click(), 2000);
            } else {
                premiumMessage.textContent = 'الكود غير صحيح، حاول مرة أخرى.';
                premiumMessage.style.color = '#ef4444';
            }
        });
        
        // History Modal Listeners
        historyButton.addEventListener('click', () => {
            renderChatHistory();
            historyModal.style.display = 'flex';
            historyModal.style.opacity = '1';
        });

        closeHistoryModal.addEventListener('click', () => {
            historyModal.style.opacity = '0';
            setTimeout(() => {
                historyModal.style.display = 'none';
            }, 300);
        });

        // Goals Modal Listeners
        goalsButton.addEventListener('click', () => {
            goalsModal.style.display = 'flex';
        });

        closeGoalsModal.addEventListener('click', () => {
            goalsModal.style.display = 'none';
        });

        addGoalButton.addEventListener('click', () => {
            const type = goalTypeSelect.value;
            const target = parseInt(goalTargetInput.value);
            
            if (target > 0) {
                addGoal(type, target);
                goalTargetInput.value = '';
            }
        });

        // On page load
        window.onload = function() {
            // Load chat sessions
            const savedSessions = localStorage.getItem(CHAT_SESSIONS_KEY);
            if (savedSessions) {
                chatSessions = JSON.parse(savedSessions);
            }
            
            // If no sessions exist, create a new one
            if (chatSessions.length === 0) {
                currentSessionId = createNewChatSession();
            } else {
                // Load the most recent session
                const mostRecentSession = [...chatSessions].sort((a, b) => 
                    new Date(b.updatedAt) - new Date(a.updatedAt))[0];
                currentSessionId = mostRecentSession.id;
                loadChatSession(currentSessionId);
            }
            
            const profile = loadProfile();
            const premiumStatus = localStorage.getItem(PREMIUM_STATUS_KEY);
            if (premiumStatus === 'true') {
                unlimitedMessages = true;
            }
            updateMessageCounter();
            
            // Load goals and badges
            loadGoals();
            loadBadgesProgress();
            
            // Setup notifications and health tips
            setupNotifications();
            setupHealthTips();
        };

        window.addEventListener('offline', () => {
            console.log("Internet connection lost! Redirecting to offline page.");
        });
    </script>
</body>
</html>
