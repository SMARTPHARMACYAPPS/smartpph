<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitnessUp Pro - مستشارك الصحي والرياضي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* General Body and Layout Styles */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #1a202c, #2d3748);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #e2e8f0;
            overflow-y: auto;
        }
        .chat-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 768px;
            min-height: 95vh;
            background-color: #2d3748;
            border-radius: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid #4a5568;
            position: relative;
            margin-bottom: 20px;
        }
        .chat-header {
            background: linear-gradient(to right, #4c51bf, #3f448c);
            color: white;
            padding: 1.5rem;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }
        .chat-header-title {
            flex-basis: 100%;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            pointer-events: none;
        }
        .ai-star {
            display: inline-block;
            font-size: 1.5rem;
            color: #fcd34d;
            vertical-align: middle;
            margin-right: 0.5rem;
            margin-left: 0.5rem;
        }
        .chat-main-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background-color: #242b38;
            border: 2px solid #667eea;
            border-radius: 0.75rem;
            margin: 1rem;
            justify-content: flex-start;
        }

        /* Message Bubble Styles */
        .message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 1.5rem;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user {
            background-color: #4a5568;
            align-self: flex-end;
            color: #e2e8f0;
            border-bottom-right-radius: 0.5rem;
        }
        .message.ai {
            background-color: #1a202c;
            align-self: flex-start;
            color: #e2e8f0;
            border-bottom-left-radius: 0.5rem;
            position: relative;
        }
        .message-content h1, .message-content h2, .message-content h3 {
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #e2e8f0;
        }
        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.25rem; }
        .message-content h3 { font-size: 1.125rem; }
        .message-content p { margin-bottom: 0.75rem; }
        .message-content strong { color: #fcd34d; }
        .message-content a { color: #667eea; text-decoration: underline; }
        .message-content ul, .message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .message-content ul li {
            list-style-type: disc;
        }
        .message-content ol li {
            list-style-type: decimal;
        }
        .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-right: 1rem;
            color: #a0aec0;
            font-style: italic;
        }
        .message-timestamp {
            font-size: 0.7rem;
            color: #a0aec0;
            opacity: 0.7;
            margin-top: 0.25rem;
            text-align: right;
            position: absolute;
            bottom: 5px;
            right: 15px;
        }
        .message.ai .message-timestamp {
            text-align: left;
            left: 15px;
            right: auto;
        }
        .message.thinking-bubble {
            background-color: #3f448c;
            color: #e2e8f0;
            font-style: italic;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            align-self: flex-start;
            animation: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .thinking-bubble .dot {
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            animation: dotWave 1s infinite ease-in-out;
        }
        .thinking-bubble .dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-bubble .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes dotWave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-7px); }
        }
        .message.highlight-green {
            animation: highlightGreen 0.3s ease-in-out forwards;
        }
        @keyframes highlightGreen {
            0% { background-color: #1a202c; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
            50% { background-color: #38a169; box-shadow: 0 0 15px rgba(56, 161, 105, 0.7); }
            100% { background-color: #1a202c; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        }

        /* Input and Button Area Styles */
        .chat-input-area {
            display: flex;
            flex-direction: column;
            padding: 1.25rem;
            border-top: 1px solid #4a5568;
            background-color: #2d3748;
            gap: 0.75rem;
            flex-shrink: 0;
            align-items: center;
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.85rem 1.25rem;
            border: 1px solid #4a5568;
            border-radius: 2rem;
            outline: none;
            font-size: 1.05rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #1a202c;
            color: #e2e8f0;
            width: 100%;
            max-width: 100%;
        }
        .chat-input::placeholder {
            color: #a0aec0;
        }
        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            margin-top: 0.75rem;
        }
        .send-button, .stop-button, .input-action-button {
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 2rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
            flex-grow: 1;
            min-width: 120px;
        }
        .send-button:hover, .stop-button:hover, .input-action-button:hover {
            background: linear-gradient(to right, #5a67d8, #434190);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }
        .send-button:active, .stop-button:active, .input-action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        }
        .stop-button {
            background: linear-gradient(to right, #ef4444, #dc2626);
            display: none;
        }
        .stop-button:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
        }
        .disclaimer {
            text-align: center;
            font-size: 0.8rem;
            color: #a0aec0;
            padding: 1rem;
            border-top: 1px solid #4a5568;
            background-color: #2d3748;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            flex-shrink: 0;
        }

        /* Buttons and Counters */
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }
        .message-counter-area {
            text-align: center;
            font-size: 0.85rem;
            color: #a0aec0;
            padding: 0.75rem 1.25rem;
            background-color: #242b38;
            border-top: 1px solid #4a5568;
            flex-shrink: 0;
        }
        .premium-button {
            position: relative;
            overflow: hidden;
            border: 2px solid #a0aec0;
            color: #a0aec0;
            background-color: #2d3748;
            transition: border-color 0.2s, background-color 0.2s, color 0.2s;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: not-allowed;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .premium-button-active {
            border-color: #fcd34d;
            background: linear-gradient(to right, #fcd34d, #d97706);
            color: #1a202c;
            cursor: pointer;
            animation: pulse-gold 2s infinite;
        }
        .premium-button-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(252, 211, 77, 0.4);
        }
        .message-tts-button {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.25rem;
            cursor: pointer;
            color: #fcd34d;
            transition: color 0.2s;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            display: block;
        }
        .message-tts-button:hover {
            color: #d97706;
        }
        .message-tts-button.loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Image Upload Styles */
        .image-preview-container {
            margin-top: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.75rem;
            border: 2px solid #667eea;
        }
        .remove-image-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Floating and Modal Styles */
        .floating-button-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .floating-button {
            width: 50px;
            height: 50px;
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
            border: 1px solid #4a5568;
            position: relative;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-button {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            color: #a0aec0;
            cursor: pointer;
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-input, .modal-textarea, .modal-select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            background-color: #1a202c;
            color: #e2e8f0;
            resize: vertical;
        }
        .modal-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23A0AEC0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            padding-right: 2.5rem;
        }
        .modal-save-button {
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }

        /* Notification Styles */
        .notification-card {
            background-color: #242b38;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #4a5568;
        }
        .permission-message {
            background-color: #fcd34d;
            color: #1a202c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
        }
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(252, 211, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0); }
        }

        /* TTS Modal Styles */
        .tts-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }
        .tts-animation-container {
            width: 200px;
            height: 200px;
            position: relative;
        }
        .tts-bubble {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(102, 126, 234, 0.3);
            border: 2px solid #667eea;
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: center;
        }
        .tts-bubble .icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            color: #667eea;
        }
        .tts-state-text {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        /* TTS Animation States */
        .listening-animation .tts-bubble {
            animation: pulse-listening 1.5s infinite ease-out;
        }
        @keyframes pulse-listening {
            0%, 100% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        .thinking-animation .tts-bubble {
            animation: thinking-dots 1.5s infinite steps(3, end);
        }
        @keyframes thinking-dots {
            0% { transform: scale(1); }
            33% { transform: scale(1.1); }
            66% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        .speaking-animation .tts-bubble {
            animation: speaking-wave 1s infinite ease-in-out;
        }
        @keyframes speaking-wave {
            0% { box-shadow: 0 0 0 0px #667eea, 0 0 0 0px #667eea; }
            50% { box-shadow: 0 0 0 20px rgba(102, 126, 234, 0.4), 0 0 0 40px rgba(102, 126, 234, 0.2); }
            100% { box-shadow: 0 0 0 40px rgba(102, 126, 234, 0), 0 0 0 40px rgba(102, 126, 234, 0); }
        }
        .interrupted-animation .tts-bubble {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }

        .tts-stop-button {
            background-color: #ef4444;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .tts-stop-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.5);
        }
        
        .disabled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 1.5rem;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .disabled-message {
            background-color: #ef4444;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            body { padding: 10px; }
            .chat-wrapper { height: auto; min-height: 90vh; max-width: 98%; margin: 0 auto; }
            .chat-header { padding: 1rem; }
            .chat-header-title { font-size: 1.5rem; margin-bottom: 0; }
            .back-button { top: 10px; right: 10px; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
            .chat-messages { margin: 0.5rem; padding: 1rem; }
            .message { padding: 0.8rem 1rem; font-size: 0.9rem; }
            .chat-input-area { padding: 0.8rem; }
            .chat-input { margin-bottom: 0.5rem; }
            .button-row { flex-direction: column; gap: 0.5rem; }
            .send-button, .stop-button, .input-action-button { width: 100%; margin: 0; }
            .message-tts-button { font-size: 1rem; top: 5px; left: 5px; }
            .floating-button-container { bottom: 10px; left: 10px; }
            .floating-button { width: 45px; height: 45px; }
        }

        /* Image Message Styles */
        .image-message-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .image-message-caption {
            font-size: 0.9rem;
            color: #a0aec0;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>

    <div id="back-button" class="back-button" onclick="history.back()">
        <i class="fas fa-arrow-right"></i>
        <span>الرجوع</span>
    </div>

    <div class="chat-wrapper">
        <div class="chat-header">
            <span class="chat-header-title">FitnessUp Pro <span class="ai-star">✦</span> PPH AI</span>
        </div>

        <div class="chat-main-content">
            <div class="chat-messages" id="chat-messages">
                <!-- Chat messages will be appended here -->
            </div>
            
            <div id="message-counter-area" class="message-counter-area">
                الرسائل المتبقية: <span id="message-counter">3</span>
            </div>
        </div>

        <div class="chat-input-area">
            <input type="file" id="image-upload" accept="image/*" class="hidden">
            <div id="image-preview-container" class="image-preview-container hidden">
                <img id="image-preview" class="image-preview" src="" alt="Image preview">
                <button id="remove-image-button" class="remove-image-button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <input type="text" id="user-input" class="chat-input" placeholder="اكتب سؤالك عن الصحة أو اللياقة البدنية هنا...">
            <div id="image-upload-warning" class="text-sm text-yellow-400 hidden">يرجى كتابة تعليق مع الصورة قبل الإرسال</div>
            <div class="button-row">
                <button id="send-button" class="send-button">
                    <i class="fas fa-paper-plane"></i> إرسال
                </button>
                <button id="image-upload-button" class="input-action-button">
                    <i class="fas fa-camera"></i> صورة
                </button>
                <button id="suggest-question-button" class="input-action-button">
                    <i class="fas fa-question-circle"></i> اقترح سؤالا
                </button>
                <button id="clear-chat-button" class="input-action-button">
                    <i class="fas fa-trash-alt"></i> مسح المحادثة
                </button>
                <button id="stop-button" class="stop-button">
                    <i class="fas fa-stop-circle"></i> إيقاف
                </button>
            </div>
        </div>
        <div class="disclaimer">
            <p>
                <i class="fas fa-exclamation-triangle"></i>
                يرجى ملاحظة أن هذه الاستشارات ليست بديلاً عن الطبيب. يجب استشارة أخصائي قبل اتخاذ أي قرارات صحية.
                <br>
                <i class="fas fa-info-circle"></i>
                ملحوظة: يجب ترك التطبيق مفتوحًا لضمان استمرارية التنبيهات.
            </p>
        </div>
    </div>

    <!-- Floating Buttons Container -->
    <div class="floating-button-container">
        <button id="notification-button" class="floating-button" title="إعداد التنبيهات">
            <i class="fas fa-bell"></i>
        </button>
        <button id="tts-popup-button" class="floating-button" title="التحدث الصوتي">
            <i class="fas fa-microphone"></i>
        </button>
        <button id="profile-button" class="floating-button" title="ملف التعريف">
            <i class="fas fa-user-circle"></i>
        </button>
        <button id="premium-button" class="floating-button" title="كود المحاولات">
            <i class="fas fa-key"></i>
        </button>
    </div>

    <!-- Modals for TTS, Notifications, Profile, and Premium Code -->
    <div id="tts-modal" class="tts-modal">
        <div class="tts-animation-container">
            <div id="tts-bubble" class="tts-bubble listening-animation">
                <i id="tts-icon" class="fas fa-microphone icon"></i>
            </div>
        </div>
        <div id="tts-state-text" class="tts-state-text">
            جاري الاستماع...
        </div>
        <button id="tts-interrupt-button" class="tts-stop-button mt-4">
            مقاطعة / إيقاف
        </button>
    </div>

    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-notification-modal">&times;</span>
            <h2 class="modal-header">إعداد التنبيهات</h2>
            <div class="notification-card">
                <p class="font-semibold mb-2">أضف تنبيهًا جديدًا</p>
                <input type="text" id="notification-title-input" class="modal-input" placeholder="عنوان التنبيه (مثلاً: تذكير بشرب الماء)">
                <input type="time" id="notification-time-input" class="modal-input">
                <button id="add-notification-button" class="modal-save-button">إضافة تنبيه</button>
            </div>
            <div class="notification-card">
                <p class="font-semibold mb-2">التنبيهات المجدولة</p>
                <div id="scheduled-notifications">
                    <!-- Scheduled notifications will be displayed here -->
                    <p class="text-sm text-gray-400">لا توجد تنبيهات مجدولة حاليًا.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-profile-modal">&times;</span>
            <h2 class="modal-header">ملف التعريف</h2>
            <input type="text" id="profile-name-input" class="modal-input" placeholder="اسمك">
            <textarea id="profile-info-input" class="modal-input" placeholder="معلومات عنك"></textarea>
            <label for="voice-select" class="block text-right mb-2">نوع الصوت:</label>
            <select id="voice-select" class="modal-input modal-select">
                <option value="Kore">Kore (صوت حازم)</option>
                <option value="Puck">Puck (صوت مبهج)</option>
                <option value="Zephyr">Zephyr (صوت مشرق)</option>
                <option value="Charon">Charon (صوت إخباري)</option>
            </select>
            <button id="save-profile-button" class="modal-save-button">حفظ</button>
        </div>
    </div>

    <div id="premium-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-premium-modal">&times;</span>
            <h2 class="modal-header">كود المحاولات اللانهائية</h2>
            <p class="text-sm text-center text-gray-400 mb-4">أدخل الكود السري للحصول على محاولات غير محدودة.</p>
            <input type="password" id="premium-code-input" class="modal-input" placeholder="أدخل الكود هنا">
            <p id="premium-message" class="text-sm text-center text-red-500 mb-2"></p>
            <button id="activate-premium-button" class="modal-save-button">تفعيل</button>
        </div>
    </div>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        marked.setOptions({
            breaks: true,
            gfm: true,
        });
    </script>
    <!-- My JavaScript -->
    <script type="module">
        // Constants for storage keys
        const CHAT_HISTORY_KEY = 'chatHistory';
        const NOTIFICATIONS_KEY = 'notifications';
        const MESSAGE_COUNTER_KEY = 'messageCounter';
        const MESSAGE_DATE_KEY = 'messageDate';
        const PREMIUM_STATUS_KEY = 'premiumStatus';
        const PROFILE_KEY = 'userProfile';
        const MAX_FREE_MESSAGES = 3;
        const PREMIUM_CODE = 'Az700200';

        // Fix: Use an empty API key and let the Canvas environment handle it
        const apiKey = "AIzaSyBl6P09eSlQ8lOxqG8tjc9gU-rlBFHGSXk";
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;
        const ttsApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=" + apiKey;
        
        // DOM Elements
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const stopButton = document.getElementById('stop-button');
        const chatMessages = document.getElementById('chat-messages');
        const imageUploadButton = document.getElementById('image-upload-button');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageButton = document.getElementById('remove-image-button');
        const suggestQuestionButton = document.getElementById('suggest-question-button');
        const clearChatButton = document.getElementById('clear-chat-button');
        const ttsPopupButton = document.getElementById('tts-popup-button');
        const ttsModal = document.getElementById('tts-modal');
        const ttsInterruptButton = document.getElementById('tts-interrupt-button');
        const ttsBubble = document.getElementById('tts-bubble');
        const ttsIcon = document.getElementById('tts-icon');
        const ttsStateText = document.getElementById('tts-state-text');
        const notificationButton = document.getElementById('notification-button');
        const notificationModal = document.getElementById('notification-modal');
        const closeNotificationModal = document.getElementById('close-notification-modal');
        const addNotificationButton = document.getElementById('add-notification-button');
        const notificationTitleInput = document.getElementById('notification-title-input');
        const notificationTimeInput = document.getElementById('notification-time-input');
        const scheduledNotificationsDiv = document.getElementById('scheduled-notifications');
        const messageCounterSpan = document.getElementById('message-counter');
        const profileButton = document.getElementById('profile-button');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModal = document.getElementById('close-profile-modal');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileInfoInput = document.getElementById('profile-info-input');
        const voiceSelect = document.getElementById('voice-select');
        const saveProfileButton = document.getElementById('save-profile-button');
        const premiumButton = document.getElementById('premium-button');
        const premiumModal = document.getElementById('premium-modal');
        const closePremiumModal = document.getElementById('close-premium-modal');
        const premiumCodeInput = document.getElementById('premium-code-input');
        const premiumMessage = document.getElementById('premium-message');
        const activatePremiumButton = document.getElementById('activate-premium-button');
        const imageUploadWarning = document.getElementById('image-upload-warning');

        // State Variables
        let chatHistory = [];
        let imageToUpload = null;
        let isWaitingForResponse = false;
        let isSpeaking = false;
        let isListening = false;
        let messageCounter = 0;
        let unlimitedMessages = false;
        let selectedVoice = 'Kore';
        let currentPlayingAudio = null;
        let currentPlayingButton = null;
        let timeCounterInterval = null;

        // Speech recognition
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported.");
                return null;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'ar-SA';
            recognition.continuous = false;
            recognition.interimResults = false;
            return recognition;
        }
        let recognition = initializeSpeechRecognition();

        // ---- Storage Functions ----
        function saveChatHistory() {
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatHistory));
        }

        function loadChatHistory() {
            const savedChat = localStorage.getItem(CHAT_HISTORY_KEY);
            if (savedChat) {
                chatHistory = JSON.parse(savedChat);
                chatHistory.forEach(message => {
                    if (message.role === 'user' && message.imageUrl) {
                        displayImageMessage(message.parts[0].text, message.imageUrl);
                    } else {
                        displayMessage(message.role, message.parts[0].text);
                    }
                });
            }
        }
        
        function saveProfile() {
            const profile = {
                name: profileNameInput.value,
                info: profileInfoInput.value,
                voice: voiceSelect.value
            };
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
            selectedVoice = profile.voice;
        }

        function loadProfile() {
            const savedProfile = localStorage.getItem(PROFILE_KEY);
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                profileNameInput.value = profile.name;
                profileInfoInput.value = profile.info;
                voiceSelect.value = profile.voice;
                selectedVoice = profile.voice;
            }
        }

        function saveMessageCounter() {
            localStorage.setItem(MESSAGE_COUNTER_KEY, messageCounter);
            localStorage.setItem(MESSAGE_DATE_KEY, new Date().toDateString());
        }

        function loadMessageCounter() {
            const savedCounter = localStorage.getItem(MESSAGE_COUNTER_KEY);
            const savedDate = localStorage.getItem(MESSAGE_DATE_KEY);
            const today = new Date().toDateString();

            if (savedCounter && savedDate === today) {
                messageCounter = parseInt(savedCounter, 10);
            } else {
                messageCounter = 0;
                localStorage.removeItem(MESSAGE_COUNTER_KEY);
                localStorage.removeItem(MESSAGE_DATE_KEY);
            }
        }
        
        function updateMessageCounter() {
            loadMessageCounter();
            
            if (timeCounterInterval) {
                clearInterval(timeCounterInterval);
            }
            
            if (unlimitedMessages) {
                messageCounterSpan.textContent = "غير محدود";
            } else {
                const remaining = MAX_FREE_MESSAGES - messageCounter;
                if (remaining > 0) {
                    messageCounterSpan.textContent = remaining;
                } else {
                    const updateCounter = () => {
                        const now = new Date();
                        const midnight = new Date();
                        midnight.setHours(24, 0, 0, 0);
                        const diff = midnight.getTime() - now.getTime();
                        
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        messageCounterSpan.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    };
                    
                    updateCounter();
                    timeCounterInterval = setInterval(updateCounter, 1000);
                }
            }
        }
        
        // --- Added utility functions for TTS audio conversion ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const dataLength = pcmData.length;
            const buffer = new ArrayBuffer(44 + dataLength * 2);
            const view = new DataView(buffer);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            let offset = 0;
            // RIFF chunk descriptor
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + dataLength * 2, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;
            // FMT sub-chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2; // Audio format (1 for PCM)
            view.setUint16(offset, 1, true); offset += 2; // Number of channels
            view.setUint32(offset, sampleRate, true); offset += 4; // Sample rate
            view.setUint32(offset, sampleRate * 2, true); offset += 4; // Byte rate
            view.setUint16(offset, 2, true); offset += 2; // Block align
            view.setUint16(offset, 16, true); offset += 2; // Bits per sample
            // Data sub-chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, dataLength * 2, true); offset += 4;

            // Write PCM data
            for (let i = 0; i < dataLength; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // ---- TTS Functions ----
        async function playTTS(text, buttonElement = null) {
            return new Promise(async (resolve, reject) => {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: selectedVoice }
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };

                    const response = await fetch(ttsApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Throw the error here to be caught by the outer try-catch block
                        throw new Error('API response was not ok');
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                        const pcmBuffer = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmBuffer);
                        
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        const audio = new Audio(audioUrl);
                        currentPlayingAudio = audio;
                        currentPlayingButton = buttonElement; // Set the current playing button

                        audio.onended = () => {
                            if (currentPlayingButton) {
                                currentPlayingButton.classList.remove('loading');
                                currentPlayingButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                                currentPlayingButton = null;
                            }
                            isSpeaking = false;
                            resolve();
                        };
                        
                        audio.onerror = (e) => {
                            console.error('Audio playback error:', e);
                            if (currentPlayingButton) {
                                currentPlayingButton.classList.remove('loading');
                                currentPlayingButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                                currentPlayingButton = null;
                            }
                            isSpeaking = false;
                            reject(new Error("Audio playback error"));
                        };
                        
                        if (buttonElement) {
                            buttonElement.innerHTML = '<i class="fas fa-stop"></i>';
                        }
                        isSpeaking = true;

                        audio.play().catch(e => {
                            console.error('Playback failed:', e);
                            if (buttonElement) {
                                buttonElement.classList.remove('loading');
                                buttonElement.innerHTML = '<i class="fas fa-volume-up"></i>';
                            }
                            isSpeaking = false;
                            reject(e);
                        });
                    } else {
                        reject(new Error("Failed to get audio data from API response."));
                    }

                } catch (error) {
                    console.error('Error in playTTS:', error);
                    // Ensure the button state is reset on any failure during the API call
                    if (buttonElement) {
                        buttonElement.classList.remove('loading');
                        buttonElement.innerHTML = '<i class="fas fa-volume-up"></i>';
                    }
                    isSpeaking = false;
                    reject(error);
                }
            });
        }

        function stopTTS() {
            if (currentPlayingAudio) {
                currentPlayingAudio.pause();
                currentPlayingAudio.currentTime = 0;
                currentPlayingAudio = null;
            }
            isSpeaking = false;
            ttsModal.style.display = 'none';
            
            if (currentPlayingButton) {
                currentPlayingButton.classList.remove('loading');
                currentPlayingButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                currentPlayingButton = null;
            }
        }
        
        function setTtsState(state) {
            ttsBubble.classList.remove('listening-animation', 'thinking-animation', 'speaking-animation', 'interrupted-animation');
            
            switch (state) {
                case 'listening':
                    ttsBubble.classList.add('listening-animation');
                    ttsIcon.className = 'fas fa-microphone icon';
                    ttsStateText.textContent = 'جاري الاستماع...';
                    break;
                case 'thinking':
                    ttsBubble.classList.add('thinking-animation');
                    ttsIcon.className = 'fas fa-brain icon';
                    ttsStateText.textContent = 'جاري التفكير...';
                    break;
                case 'speaking':
                    ttsBubble.classList.add('speaking-animation');
                    ttsIcon.className = 'fas fa-comment-dots icon';
                    ttsStateText.textContent = 'جاري النطق...';
                    break;
                case 'interrupted':
                    ttsBubble.classList.add('interrupted-animation');
                    ttsIcon.className = 'fas fa-exclamation-triangle icon';
                    ttsStateText.textContent = 'تمت المقاطعة!';
                    break;
            }
        }

        // ---- UI Functions ----
        function displayMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            
            const profile = JSON.parse(localStorage.getItem(PROFILE_KEY)) || {};
            if (role === 'ai' && profile.name) {
                text = text.replace(/مرحباً بك/gi, `مرحباً ${profile.name}`);
                text = text.replace(/أهلاً بك/gi, `أهلاً ${profile.name}`);
            }
            
            contentDiv.innerHTML = marked.parse(text);

            if (role === 'ai') {
                const ttsButton = document.createElement('button');
                ttsButton.classList.add('message-tts-button');
                ttsButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                ttsButton.title = 'تشغيل الصوت';
                ttsButton.onclick = async () => {
                    // Check if another audio is already playing
                    if (currentPlayingAudio) {
                        stopTTS(); // Stop the currently playing audio
                        // If the user clicked the same button, we are done
                        if (currentPlayingButton === ttsButton) {
                            return;
                        }
                    }
                    
                    ttsButton.classList.add('loading');
                    ttsButton.innerHTML = '<i class="fas fa-spinner"></i>';
                    
                    try {
                        // The playTTS function will now handle resetting the state
                        await playTTS(text, ttsButton);
                    } catch (error) {
                        console.error("TTS Error:", error);
                        // The error handler in playTTS should now handle resetting the button
                    }
                };
                messageDiv.appendChild(ttsButton);
            }

            const timestampDiv = document.createElement('div');
            timestampDiv.classList.add('message-timestamp');
            timestampDiv.textContent = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timestampDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayImageMessage(caption, imageUrl) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'user');
            
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-message-container');
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '200px';
            img.style.borderRadius = '0.75rem';
            img.style.border = '2px solid #667eea';
            
            const captionDiv = document.createElement('div');
            captionDiv.classList.add('image-message-caption');
            captionDiv.textContent = caption;
            
            imageContainer.appendChild(img);
            imageContainer.appendChild(captionDiv);
            
            const timestampDiv = document.createElement('div');
            timestampDiv.classList.add('message-timestamp');
            timestampDiv.textContent = new Date().toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.appendChild(imageContainer);
            messageDiv.appendChild(timestampDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayThinkingBubble() {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.classList.add('message', 'thinking-bubble', 'ai');
            thinkingDiv.id = 'thinking-bubble';
            thinkingDiv.innerHTML = `
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            `;
            chatMessages.appendChild(thinkingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeThinkingBubble() {
            const thinkingDiv = document.getElementById('thinking-bubble');
            if (thinkingDiv) {
                thinkingDiv.remove();
            }
        }

        // ---- API Call Functions ----
        async function fetchGeminiResponse(prompt, imageBase64 = null) {
            if (!unlimitedMessages && messageCounter >= MAX_FREE_MESSAGES) {
                const timeRemaining = getTimeUntilMidnight();
                const responseText = `انتهت المحاولات اليومية. عد بعد (${timeRemaining}).`;
                displayMessage('ai', responseText);
                return;
            }

            isWaitingForResponse = true;
            sendButton.disabled = true;
            stopButton.style.display = 'flex';
            displayThinkingBubble();

            const contents = [];
            
            chatHistory.forEach(msg => {
                if (msg.role === "user" || msg.role === "model") {
                    contents.push(msg);
                }
            });

            const newUserMessage = {
                role: 'user',
                parts: [{ text: prompt }]
            };
            if (imageBase64) {
                newUserMessage.imageUrl = imagePreview.src;
            }
            contents.push(newUserMessage);

            const profile = JSON.parse(localStorage.getItem(PROFILE_KEY)) || {};
            
            const systemInstruction = {
                role: "model",
                parts: [{
                    text: `بصفتك مستشاراً طبياً ورياضياً ودوداً ومرحاً ومشجعاً، 
                    اجب على الرسالة التالية من غير إطالة ومن غير اختصار شديد، 
                    مستخدماً الوجوه التعبيرية لكن بعدد قليل، وحاول أن تمزج بين اللغة العربية الفصحى واللهجة المصرية إلا إذا طُلب منك غير ذلك.
                    ${profile.info ? `المعلومات التي أعطاها المستخدم عن نفسه: ${profile.info}` : ''}
                    إذا تحدث المستخدم في شيء غير الرياضة والصحة، حاول الإجابة على طلبه وفي النهاية اربط بين الصحة وطلبه.`
                }]
            };

            const payload = {
                contents: contents,
                systemInstruction: systemInstruction
            };

            let responseText = "";
            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Too many requests. Retrying...');
                        }
                        const error = await response.json();
                        throw new Error(error.error.message || 'Network response was not ok');
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        responseText = result.candidates[0].content.parts[0].text;
                    } else {
                        responseText = "عذرًا، لم أتمكن من الحصول على رد. الرجاء المحاولة مرة أخرى.";
                    }
                    
                    break;

                } catch (error) {
                    console.error('API call failed:', error);
                    retries--;
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        responseText = "عذرًا، واجهت مشكلة في الاتصال. الرجاء المحاولة لاحقًا.";
                    }
                }
            }

            removeThinkingBubble();
            displayMessage('ai', responseText);

            chatHistory.push(newUserMessage);
            chatHistory.push({ role: "model", parts: [{ text: responseText }] });
            saveChatHistory();
            
            if (!unlimitedMessages) {
                messageCounter++;
                saveMessageCounter();
                updateMessageCounter();
            }

            isWaitingForResponse = false;
            sendButton.disabled = false;
            stopButton.style.display = 'none';
            return responseText;
        }

        function getTimeUntilMidnight() {
            const now = new Date();
            const midnight = new Date();
            midnight.setHours(24, 0, 0, 0);
            const diff = midnight.getTime() - now.getTime();
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours} ساعة و ${minutes} دقيقة`;
        }

        // ---- Notification Functions ----
        function saveNotifications(notifications) {
            localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(notifications));
        }

        function loadNotifications() {
            const savedNotifications = localStorage.getItem(NOTIFICATIONS_KEY);
            return savedNotifications ? JSON.parse(savedNotifications) : [];
        }

        function setupNotifications() {
            if (!("Notification" in window)) {
                console.warn("This browser does not support desktop notification");
            } else if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }

            const notifications = loadNotifications();
            notifications.forEach(notification => {
                scheduleNotification(notification.title, notification.time);
            });
            renderScheduledNotifications();
        }

        function scheduleNotification(title, time) {
            const [hours, minutes] = time.split(':').map(Number);
            
            const now = new Date();
            let scheduledTime = new Date();
            scheduledTime.setHours(hours, minutes, 0, 0);

            if (scheduledTime < now) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }

            const delay = scheduledTime.getTime() - now.getTime();
            
            setTimeout(() => {
                if (Notification.permission === "granted") {
                    new Notification("FitnessUp Pro", {
                        body: title,
                        icon: 'https://placehold.co/64x64/4c51bf/ffffff?text=FP',
                        vibrate: [200, 100, 200]
                    });
                }
                scheduleNotification(title, time);
            }, delay);
        }

        function renderScheduledNotifications() {
            const notifications = loadNotifications();
            scheduledNotificationsDiv.innerHTML = '';
            if (notifications.length === 0) {
                scheduledNotificationsDiv.innerHTML = '<p class="text-sm text-gray-400">لا توجد تنبيهات مجدولة حاليًا.</p>';
                return;
            }
            notifications.forEach((notification, index) => {
                const notificationItem = document.createElement('div');
                notificationItem.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'border-b', 'border-gray-600', 'last:border-b-0');
                notificationItem.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-medium">${notification.title}</p>
                        <p class="text-sm text-gray-400">الوقت: ${notification.time}</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700 transition-colors" data-index="${index}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                scheduledNotificationsDiv.appendChild(notificationItem);
            });
        }
        
        scheduledNotificationsDiv.addEventListener('click', (e) => {
            if (e.target.closest('button')) {
                const index = e.target.closest('button').dataset.index;
                let notifications = loadNotifications();
                notifications.splice(index, 1);
                saveNotifications(notifications);
                location.reload(); 
            }
        });

        // Profile Modal Listeners
        profileButton.addEventListener('click', () => {
            loadProfile();
            profileModal.style.display = 'flex';
            profileModal.style.opacity = '1';
        });

        closeProfileModal.addEventListener('click', () => {
            profileModal.style.opacity = '0';
            setTimeout(() => {
                profileModal.style.display = 'none';
            }, 300);
        });

        saveProfileButton.addEventListener('click', () => {
            saveProfile();
            closeProfileModal.click();
        });

        // Premium Modal Listeners
        premiumButton.addEventListener('click', () => {
            premiumCodeInput.value = '';
            premiumMessage.textContent = '';
            premiumModal.style.display = 'flex';
            premiumModal.style.opacity = '1';
        });

        closePremiumModal.addEventListener('click', () => {
            premiumModal.style.opacity = '0';
            setTimeout(() => {
                premiumModal.style.display = 'none';
            }, 300);
        });

        activatePremiumButton.addEventListener('click', () => {
            if (premiumCodeInput.value === PREMIUM_CODE) {
                localStorage.setItem(PREMIUM_STATUS_KEY, 'true');
                unlimitedMessages = true;
                premiumMessage.textContent = 'تم تفعيل المحاولات اللانهائية بنجاح!';
                premiumMessage.style.color = '#38a169';
                updateMessageCounter();
                setTimeout(() => closePremiumModal.click(), 2000);
            } else {
                premiumMessage.textContent = 'الكود غير صحيح، حاول مرة أخرى.';
                premiumMessage.style.color = '#ef4444';
            }
        });
        
        // ---- Event Listeners ----
        sendButton.addEventListener('click', () => {
            const prompt = userInput.value.trim();
            
            if (imageToUpload && !prompt) {
                imageUploadWarning.classList.remove('hidden');
                return;
            } else {
                imageUploadWarning.classList.add('hidden');
            }
            
            if ((prompt !== '' || imageToUpload) && !isWaitingForResponse) {
                if (imageToUpload) {
                    displayImageMessage(prompt || "صورة بدون تعليق", imagePreview.src);
                } else {
                    displayMessage('user', prompt);
                }
                
                userInput.value = '';
                const imageBase64 = imageToUpload ? imagePreview.src.split(',')[1] : null;
                fetchGeminiResponse(prompt || "يرجى تحليل هذه الصورة", imageBase64);
                imageToUpload = null;
                imagePreviewContainer.classList.add('hidden');
                imagePreview.src = '';
            }
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        stopButton.addEventListener('click', () => {
            removeThinkingBubble();
            isWaitingForResponse = false;
            sendButton.disabled = false;
            stopButton.style.display = 'none';
        });

        imageUploadButton.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToUpload = file;
                    imagePreview.src = event.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    
                    if (!userInput.value.trim()) {
                        imageUploadWarning.classList.remove('hidden');
                    } else {
                        imageUploadWarning.classList.add('hidden');
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageButton.addEventListener('click', () => {
            imageToUpload = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            imageUpload.value = '';
            imageUploadWarning.classList.add('hidden');
        });

        suggestQuestionButton.addEventListener('click', () => {
            if (isWaitingForResponse) return;
            const suggestions = [
                'ما هو أفضل نظام غذائي لزيادة الكتلة العضلية؟',
                'كيف يمكنني أن أحرق الدهون بشكل أسرع؟',
                'ما هي التمارين الرياضية المناسبة للمبتدئين؟',
                'هل يمكن أن تعطيني خطة تدريبية لمدة أسبوع؟',
                'ما أهمية شرب الماء أثناء التمرين؟'
            ];
            const randomQuestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            userInput.value = randomQuestion;
            imageUploadWarning.classList.add('hidden');
        });

        clearChatButton.addEventListener('click', () => {
            chatHistory = [];
            saveChatHistory();
            chatMessages.innerHTML = '';
            
            const welcomeMessage = 'مرحباً بك في FitnessUp Pro! أنا **مستشارك الشخصي في الصحة واللياقة البدنية**. يسعدني أن أقدم لك استشارات طبية ونصائح رياضية لمساعدتك في تحقيق أهدافك. كيف يمكنني مساعدتك اليوم؟';
            displayMessage('ai', welcomeMessage);
            chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
            saveChatHistory();
        });

        // TTS Modal Listeners
        ttsPopupButton.addEventListener('click', () => {
            ttsModal.style.display = 'flex';
            setTtsState('listening');
            startSpeechRecognition();
        });
        
        ttsInterruptButton.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
                setTtsState('interrupted');
                setTimeout(() => ttsModal.style.display = 'none', 1000);
            } else if (isSpeaking) {
                stopTTS();
                setTtsState('interrupted');
                setTimeout(() => ttsModal.style.display = 'none', 1000);
            }
        });
        
        function startSpeechRecognition() {
            if (!recognition) return;
            isListening = true;
            recognition.start();
        }
        
        if (recognition) {
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log("Recognized:", transcript);
                setTtsState('thinking');
                isListening = false;
                
                displayMessage('user', transcript);

                fetchGeminiResponse(transcript).then((responseText) => {
                    if (responseText) {
                        setTtsState('speaking');
                        playTTS(responseText).then(() => {
                            setTtsState('listening');
                            startSpeechRecognition();
                        }).catch(error => {
                            console.error("TTS Error:", error);
                            ttsModal.style.display = 'none';
                        });
                    }
                });
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                isListening = false;
                setTtsState('interrupted');
                setTimeout(() => ttsModal.style.display = 'none', 1000);
            };

            recognition.onend = () => {
                isListening = false;
                if (!isSpeaking && ttsModal.style.display === 'flex') {
                    setTimeout(() => {
                        setTtsState('listening');
                        startSpeechRecognition();
                    }, 1000);
                }
            };
        }

        // Notification Modal Listeners
        notificationButton.addEventListener('click', () => {
            notificationModal.style.display = 'flex';
            notificationModal.style.opacity = '1';
        });

        closeNotificationModal.addEventListener('click', () => {
            notificationModal.style.opacity = '0';
            setTimeout(() => {
                notificationModal.style.display = 'none';
            }, 300);
        });

        addNotificationButton.addEventListener('click', () => {
            const title = notificationTitleInput.value.trim();
            const time = notificationTimeInput.value;

            if (title && time) {
                const notifications = loadNotifications();
                notifications.push({ title, time });
                saveNotifications(notifications);
                setupNotifications();
                renderScheduledNotifications();
                notificationTitleInput.value = '';
                notificationTimeInput.value = '';
            }
        });
        
        scheduledNotificationsDiv.addEventListener('click', (e) => {
            if (e.target.closest('button')) {
                const index = e.target.closest('button').dataset.index;
                let notifications = loadNotifications();
                notifications.splice(index, 1);
                saveNotifications(notifications);
                location.reload(); 
            }
        });

        // Profile Modal Listeners
        profileButton.addEventListener('click', () => {
            loadProfile();
            profileModal.style.display = 'flex';
            profileModal.style.opacity = '1';
        });

        closeProfileModal.addEventListener('click', () => {
            profileModal.style.opacity = '0';
            setTimeout(() => {
                profileModal.style.display = 'none';
            }, 300);
        });

        saveProfileButton.addEventListener('click', () => {
            saveProfile();
            closeProfileModal.click();
        });

        // Premium Modal Listeners
        premiumButton.addEventListener('click', () => {
            premiumCodeInput.value = '';
            premiumMessage.textContent = '';
            premiumModal.style.display = 'flex';
            premiumModal.style.opacity = '1';
        });

        closePremiumModal.addEventListener('click', () => {
            premiumModal.style.opacity = '0';
            setTimeout(() => {
                premiumModal.style.display = 'none';
            }, 300);
        });

        activatePremiumButton.addEventListener('click', () => {
            if (premiumCodeInput.value === PREMIUM_CODE) {
                localStorage.setItem(PREMIUM_STATUS_KEY, 'true');
                unlimitedMessages = true;
                premiumMessage.textContent = 'تم تفعيل المحاولات اللانهائية بنجاح!';
                premiumMessage.style.color = '#38a169';
                updateMessageCounter();
                setTimeout(() => closePremiumModal.click(), 2000);
            } else {
                premiumMessage.textContent = 'الكود غير صحيح، حاول مرة أخرى.';
                premiumMessage.style.color = '#ef4444';
            }
        });

        // On page load
        window.onload = function() {
            loadChatHistory();
            loadProfile();
            const premiumStatus = localStorage.getItem(PREMIUM_STATUS_KEY);
            if (premiumStatus === 'true') {
                unlimitedMessages = true;
            }
            updateMessageCounter();
            if (chatHistory.length === 0) {
                setTimeout(() => {
                    const welcomeMessage = 'مرحباً بك في FitnessUp Pro! أنا **مستشارك الشخصي في الصحة واللياقة البدنية**. يسعدني أن أقدم لك استشارات طبية ونصائح رياضية لمساعدتك في تحقيق أهدافك. كيف يمكنني مساعدتك اليوم؟';
                    displayMessage('ai', welcomeMessage);
                    chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
                    saveChatHistory();
                }, 500);
            }
            setupNotifications();
        };

        window.addEventListener('offline', () => {
            console.log("Internet connection lost! Redirecting to offline page.");
        });
    </script>
</body>
</html>
