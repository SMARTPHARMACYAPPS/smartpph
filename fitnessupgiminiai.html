<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitnessUp Pro - مستشارك الصحي والرياضي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #1a202c, #2d3748);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #e2e8f0;
            overflow-y: auto;
        }
        .chat-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 768px;
            min-height: 95vh;
            background-color: #2d3748;
            border-radius: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid #4a5568;
            position: relative;
            margin-bottom: 20px;
        }
        .chat-header {
            background: linear-gradient(to right, #4c51bf, #3f448c);
            color: white;
            padding: 1.5rem;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }
        .chat-header-title {
            flex-basis: 100%;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            pointer-events: none;
        }
        .ai-star {
            display: inline-block;
            font-size: 1.5rem;
            color: #fcd34d;
            vertical-align: middle;
            margin-right: 0.5rem;
            margin-left: 0.5rem;
        }
        .chat-main-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background-color: #242b38;
            border: 2px solid #667eea;
            border-radius: 0.75rem;
            margin: 1rem;
            justify-content: flex-start;
        }
        .message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 1.5rem;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user {
            background-color: #4a5568;
            align-self: flex-end;
            color: #e2e8f0;
            border-bottom-right-radius: 0.5rem;
        }
        .message.ai {
            background-color: #1a202c;
            align-self: flex-start;
            color: #e2e8f0;
            border-bottom-left-radius: 0.5rem;
            position: relative;
        }
        .message-content h1, .message-content h2, .message-content h3 {
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #e2e8f0;
        }
        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.25rem; }
        .message-content h3 { font-size: 1.125rem; }
        .message-content p { margin-bottom: 0.75rem; }
        .message-content strong { color: #fcd34d; }
        .message-content a { color: #667eea; text-decoration: underline; }
        .message-content ul, .message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .message-content ul li {
            list-style-type: disc;
        }
        .message-content ol li {
            list-style-type: decimal;
        }
        .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-right: 1rem;
            color: #a0aec0;
            font-style: italic;
        }

        .message-timestamp {
            font-size: 0.7rem;
            color: #a0aec0;
            opacity: 0.7;
            margin-top: 0.25rem;
            text-align: right;
            position: absolute;
            bottom: 5px;
            right: 15px;
        }
        .message.ai .message-timestamp {
            text-align: left;
            left: 15px;
            right: auto;
        }
        .message.thinking-bubble {
            background-color: #3f448c;
            color: #e2e8f0;
            font-style: italic;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            align-self: flex-start;
            animation: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .thinking-bubble .dot {
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            animation: dotWave 1s infinite ease-in-out;
        }
        .thinking-bubble .dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-bubble .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes dotWave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-7px); }
        }

        .message.highlight-green {
            animation: highlightGreen 0.3s ease-in-out forwards;
        }
        @keyframes highlightGreen {
            0% { background-color: #1a202c; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
            50% { background-color: #38a169; box-shadow: 0 0 15px rgba(56, 161, 105, 0.7); }
            100% { background-color: #1a202c; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        }
        .chat-input-area {
            display: flex;
            flex-direction: column;
            padding: 1.25rem;
            border-top: 1px solid #4a5568;
            background-color: #2d3748;
            gap: 0.75rem;
            flex-shrink: 0;
            align-items: center;
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.85rem 1.25rem;
            border: 1px solid #4a5568;
            border-radius: 2rem;
            outline: none;
            font-size: 1.05rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #1a202c;
            color: #e2e8f0;
            width: 100%;
            max-width: 100%;
        }
        .chat-input::placeholder {
            color: #a0aec0;
        }
        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            margin-top: 0.75rem;
        }
        .send-button, .stop-button, .input-action-button {
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 2rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
            flex-grow: 1;
            min-width: 120px;
        }
        .send-button:hover, .stop-button:hover, .input-action-button:hover {
            background: linear-gradient(to right, #5a67d8, #434190);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }
        .send-button:active, .stop-button:active, .input-action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        }
        .stop-button {
            background: linear-gradient(to right, #ef4444, #dc2626);
            display: none;
        }
        .stop-button:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
        }
        .disclaimer {
            text-align: center;
            font-size: 0.8rem;
            color: #a0aec0;
            padding: 1rem;
            border-top: 1px solid #4a5568;
            background-color: #2d3748;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            flex-shrink: 0;
        }
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }
        .message-counter-area {
            text-align: center;
            font-size: 0.85rem;
            color: #a0aec0;
            padding: 0.75rem 1.25rem;
            background-color: #242b38;
            border-top: 1px solid #4a5568;
            flex-shrink: 0;
        }
        .premium-button {
            position: relative;
            overflow: hidden;
            border: 2px solid #a0aec0;
            color: #a0aec0;
            background-color: #2d3748;
            transition: border-color 0.2s, background-color 0.2s, color 0.2s;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: not-allowed;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .premium-button-active {
            border-color: #fcd34d;
            background: linear-gradient(to right, #fcd34d, #d97706);
            color: #1a202c;
            cursor: pointer;
            animation: pulse-gold 2s infinite;
        }
        .premium-button-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(252, 211, 77, 0.4);
        }
        .tts-button {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.25rem;
            cursor: pointer;
            color: #fcd34d;
            transition: color 0.2s;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            display: block;
        }
        .tts-button:hover {
            color: #d97706;
        }
        .image-preview-container {
            margin-top: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.75rem;
            border: 2px solid #667eea;
        }
        .remove-image-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .floating-button-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .floating-button {
            width: 50px;
            height: 50px;
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
            border: 1px solid #4a5568;
            position: relative;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-button {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            color: #a0aec0;
            cursor: pointer;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .modal-textarea, .modal-select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            background-color: #1a202c;
            color: #e2e8f0;
            resize: vertical;
        }
        .modal-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23A0AEC0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            padding-right: 2.5rem;
        }

        .modal-save-button {
            background: linear-gradient(to right, #667eea, #5a67d8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }
        
        .notification-card {
            background-color: #242b38;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #4a5568;
        }
        .permission-message {
            background-color: #fcd34d;
            color: #1a202c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(252, 211, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0); }
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            body {
                padding: 10px;
            }
            .chat-wrapper {
                height: auto;
                min-height: 90vh;
                max-width: 98%;
                margin: 0 auto;
            }
            .chat-header {
                padding: 1rem;
            }
            .chat-header-title {
                font-size: 1.5rem;
                margin-bottom: 0;
            }
            .back-button {
                top: 10px;
                right: 10px;
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .chat-messages {
                margin: 0.5rem;
                padding: 1rem;
            }
            .message {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
            .chat-input-area {
                padding: 0.8rem;
            }
            .chat-input {
                margin-bottom: 0.5rem;
            }
            .button-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            .send-button, .stop-button, .input-action-button {
                width: 100%;
                margin: 0;
            }
            .tts-button {
                font-size: 1rem;
                top: 5px;
                left: 5px;
            }
            .floating-button-container {
                bottom: 10px;
                left: 10px;
            }
            .floating-button {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-wrapper">
        <div class="chat-header">
            <span class="chat-header-title">FitnessUp Pro <span class="ai-star">✦</span> PPH AI</span>
        </div>
        <div class="chat-main-content">
            <div class="chat-messages" id="chat-messages">
                </div>
            <div class="chat-input-area">
                <input type="file" id="image-upload" accept="image/*" class="hidden">
                <div id="image-preview-container" class="image-preview-container hidden">
                    <img id="image-preview" class="image-preview" src="" alt="Image preview">
                    <button id="remove-image-button" class="remove-image-button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <input type="text" id="user-input" class="chat-input" placeholder="اكتب سؤالك عن الصحة أو اللياقة البدنية هنا...">
                <div class="button-row">
                    <button id="send-button" class="send-button">
                        <i class="fas fa-paper-plane"></i>
                        إرسال
                    </button>
                    <button id="image-upload-button" class="input-action-button"> <i class="fas fa-camera"></i>
                        صورة
                    </button>
                    <button id="suggest-question-button" class="input-action-button">
                        <i class="fas fa-question-circle"></i> اقترح سؤالا
                    </button>
                    <button id="clear-chat-button" class="input-action-button">
                        <i class="fas fa-trash-alt"></i> مسح المحادثة
                    </button>
                    <button id="stop-button" class="stop-button">
                        <i class="fas fa-stop"></i>
                        إيقاف
                    </button>
                    <button id="voice-chat-button" class="input-action-button">
                        <i class="fas fa-microphone"></i> تحدث صوتيًا
                    </button>
                    <button id="notifications-button" class="input-action-button">
                        <i class="fas fa-bell"></i> تنبيهات
                    </button>
                </div>
            </div>
            <div class="message-counter-area" id="message-counter-area">
                الرسائل المتبقية اليوم: <span id="remaining-messages">10</span>
                <span id="voice-timer" class="mr-4"></span>
            </div>
            <div class="disclaimer">
                <i class="fas fa-exclamation-triangle text-yellow-500 ml-2"></i>
                يرجى ملاحظة: هذا النموذج للذكاء الاصطناعي قد يقدم معلومات غير دقيقة. يرجى دائماً التحقق من صحة المعلومات واستشارة أخصائي قبل اتخاذ أي قرارات صحية أو رياضية.
            </div>
        </div>
    </div>
    <button id="back-button" class="back-button">
        <i class="fas fa-arrow-right"></i>
        العودة
    </button>
    
    <div class="floating-button-container">
        <button id="profile-button" class="floating-button">
            <i class="fas fa-user-circle text-2xl"></i>
        </button>
    </div>

    <!-- Modals (pop-up windows) -->
    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <button class="close-button" id="close-profile-modal"><i class="fas fa-times"></i></button>
            <h2 class="modal-header">ملفك الشخصي وإعدادات الصوت</h2>
            <p class="text-sm text-gray-400 text-center mb-4">سيتم استخدام هذه المعلومات لتقديم نصائح مخصصة.</p>
            <input type="text" id="profile-name" class="modal-input" placeholder="اسمك">
            <textarea id="profile-description" class="modal-textarea" rows="4" placeholder="وصف عن نفسك (مثال: 'أنا شاب عمري 25 سنة، أرغب في بناء العضلات وخسارة 5 كجم. أمارس الرياضة 3 مرات في الأسبوع.')."></textarea>
            
            <h3 class="font-semibold text-lg text-center mb-2 mt-4">اعدادات الصوت</h3>
            <select id="tts-voice-select" class="modal-select">
                <option value="Puck">Puck (متحمس)</option>
                <option value="Kore">Kore (مؤثر)</option>
                <option value="Zephyr">Zephyr (مشرق)</option>
                <option value="Charon">Charon (إخباري)</option>
                <option value="Alnilam">Alnilam (حازم)</option>
            </select>

            <button id="save-profile-button" class="modal-save-button">حفظ</button>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal">
        <div class="modal-content">
            <button class="close-button" id="close-notifications-modal"><i class="fas fa-times"></i></button>
            <h2 class="modal-header">تنبيهات مخصصة</h2>
            <p class="text-sm text-gray-400 text-center mb-4">اضبط الفترات الزمنية لتنبيهات الماء والتمارين.</p>
            <div class="notification-card flex flex-col items-center">
                <div class="flex items-center w-full mb-2">
                    <h3 class="font-semibold text-lg flex-grow">تنبيه شرب الماء</h3>
                </div>
                <div class="flex items-center w-full">
                    <input type="number" id="water-hours" class="modal-input w-1/3 text-center ml-2" placeholder="ساعة" min="0" max="24">
                    <span class="text-gray-400 mr-2">:</span>
                    <input type="number" id="water-minutes" class="modal-input w-1/3 text-center" placeholder="دقيقة" min="0" max="59">
                </div>
            </div>
            <div class="notification-card flex flex-col items-center">
                <div class="flex items-center w-full mb-2">
                    <h3 class="font-semibold text-lg flex-grow">تنبيه التمارين</h3>
                </div>
                <div class="flex items-center w-full">
                    <input type="number" id="exercise-hours" class="modal-input w-1/3 text-center ml-2" placeholder="ساعة" min="0" max="24">
                    <span class="text-gray-400 mr-2">:</span>
                    <input type="number" id="exercise-minutes" class="modal-input w-1/3 text-center" placeholder="دقيقة" min="0" max="59">
                </div>
            </div>
            <button id="save-notifications-button" class="modal-save-button">حفظ التنبيهات</button>
        </div>
    </div>

    <script type="module">
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const stopButton = document.getElementById('stop-button');
        const backButton = document.getElementById('back-button');
        const clearChatButton = document.getElementById('clear-chat-button');
        const suggestQuestionButton = document.getElementById('suggest-question-button');
        const imageUploadButton = document.getElementById('image-upload-button');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageButton = document.getElementById('remove-image-button');
        const messageCounterArea = document.getElementById('message-counter-area');
        const messageCounterDisplay = document.getElementById('remaining-messages');
        const voiceChatButton = document.getElementById('voice-chat-button');
        const notificationsButton = document.getElementById('notifications-button');
        const profileButton = document.getElementById('profile-button');
        const voiceTimerDisplay = document.getElementById('voice-timer');

        // Profile Modal elements
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalButton = document.getElementById('close-profile-modal');
        const profileNameInput = document.getElementById('profile-name');
        const profileDescriptionTextarea = document.getElementById('profile-description');
        const ttsVoiceSelect = document.getElementById('tts-voice-select');
        const saveProfileButton = document.getElementById('save-profile-button');

        // Notifications Modal elements
        const notificationsModal = document.getElementById('notifications-modal');
        const closeNotificationsModalButton = document.getElementById('close-notifications-modal');
        const waterHoursInput = document.getElementById('water-hours');
        const waterMinutesInput = document.getElementById('water-minutes');
        const exerciseHoursInput = document.getElementById('exercise-hours');
        const exerciseMinutesInput = document.getElementById('exercise-minutes');
        const saveNotificationsButton = document.getElementById('save-notifications-button');

        let thinkingBubbleElement = null;
        let currentAiMessageElement = null;
        let abortController = null;
        let typingIntervalId = null;
        let uploadedImage = null;
        let chatHistory = [];
        const MAX_MESSAGES_PER_DAY = 10;
        let remainingMessages = MAX_MESSAGES_PER_DAY;
        let unlimitedMessages = false;
        let premiumEnabled = false;
        const CHAT_HISTORY_KEY = 'fitnessUpProChatHistory';
        const MESSAGE_COUNT_KEY = 'fitnessUpProMessageCount';
        const LAST_RESET_DATE_KEY = 'fitnessUpProLastResetDate';
        const NOTIFICATIONS_SETTINGS_KEY = 'fitnessUpProNotifications';
        const UNLOCK_CODE = 'Az700200';
        const PREMIUM_STATUS_KEY = 'fitnessUpProPremium';
        const USER_PROFILE_KEY = 'fitnessUpProUserProfile';

        // Voice chat timer variables
        const MAX_VOICE_DURATION = 5 * 60; // 5 minutes in seconds
        const VOICE_DURATION_KEY = 'fitnessUpProVoiceDuration';
        const VOICE_LAST_RESET_DATE_KEY = 'fitnessUpProVoiceLastResetDate';
        let voiceChatDuration = 0; // in seconds
        let voiceTimerInterval = null;
        
        let notificationIntervals = {};
        let isVoiceChatActive = false;
        let ttsAudio = null;

        const randomQuestions = [
            "ما هي أفضل تمارين الإحماء قبل الجري؟",
            "كيف يمكنني زيادة مرونتي؟",
            "ما هي الأطعمة الغنية بالبروتين للنباتيين؟",
            "كيف أتعامل مع آلام العضلات بعد التمرين؟",
            "ما هي فوائد اليوغا للصحة العقلية والبدنية؟",
            "كم ساعة نوم أحتاج لتحسين الأداء الرياضي؟",
            "ما هي أفضل طريقة لإنقاص الوزن بشكل صحي؟",
            "هل المكملات الغذائية ضرورية للمبتدئين في كمال الأجسام؟",
            "كيف أبدأ روتين لياقة بدنية في المنزل؟",
            "ما هي علامات الإفراط في التدريب وكيف أتجنبها؟"
        ];

        // Function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Function to convert PCM audio to a WAV file Blob
        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const dataLength = pcm16.length * 2;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Function to play TTS audio
        async function playTTS(text) {
            const allTTSButtons = document.querySelectorAll('.tts-button');
            allTTSButtons.forEach(btn => btn.disabled = true);
            
            const userProfile = JSON.parse(localStorage.getItem(USER_PROFILE_KEY) || '{}');
            const voiceName = userProfile.ttsVoice || 'Puck'; // Use selected voice or default to Puck

            try {
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: voiceName }
                            }
                        }
                    }
                };
                const apiKey = "AIzaSyBl6P09eSlQ8lOxqG8tjc9gU-rlBFHGSXk";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                let response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    if (ttsAudio) {
                        ttsAudio.pause();
                        URL.revokeObjectURL(ttsAudio.src);
                    }
                    ttsAudio = new Audio(audioUrl);
                    
                    ttsAudio.onplay = () => {
                        const messageToHighlight = document.querySelector(`.message.ai:last-child`);
                        if (messageToHighlight) {
                            messageToHighlight.classList.add('highlight-green');
                        }
                    };
                    
                    ttsAudio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        allTTSButtons.forEach(btn => btn.disabled = false);
                        const highlightedMessage = document.querySelector('.message.highlight-green');
                        if (highlightedMessage) {
                            highlightedMessage.classList.remove('highlight-green');
                        }
                        if (isVoiceChatActive) {
                            startSpeechRecognition();
                        }
                    };
                    ttsAudio.play();

                } else {
                    console.error("TTS audio data not found or invalid format.");
                    allTTSButtons.forEach(btn => btn.disabled = false);
                }
            } catch (error) {
                console.error("Error playing TTS audio:", error);
                allTTSButtons.forEach(btn => btn.disabled = false);
            }
        }
        
        // General purpose fetch with exponential backoff
        async function fetchWithExponentialBackoff(url, options, maxRetries = 3) {
            let retries = 0;
            while (retries < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        const delay = Math.pow(2, retries) * 1000;
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                    return response;
                } catch (error) {
                    if (retries < maxRetries - 1) {
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, retries) * 1000));
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Function to create a message element
        function createMessageElement(role, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(role);
            messageElement.innerHTML = `
                <div class="message-content">${marked.parse(text)}</div>
                <div class="message-timestamp">${new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            if (role === 'ai') {
                const ttsButton = document.createElement('button');
                ttsButton.classList.add('tts-button');
                ttsButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                ttsButton.onclick = () => playTTS(text);
                messageElement.appendChild(ttsButton);
            }
            return messageElement;
        }

        // Function to display a message
        function displayMessage(role, text, shouldAnimate = true) {
            const messageElement = createMessageElement(role, text);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            if (role === 'ai' && shouldAnimate) {
                currentAiMessageElement = messageElement;
                animateTyping(text);
            } else {
                currentAiMessageElement = null;
            }
        }

        // Function to animate the AI typing
        function animateTyping(fullText) {
            let i = 0;
            const messageContent = currentAiMessageElement.querySelector('.message-content');
            messageContent.innerHTML = '';
            
            typingIntervalId = setInterval(() => {
                if (i < fullText.length) {
                    messageContent.innerHTML += fullText.charAt(i);
                    i++;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    clearInterval(typingIntervalId);
                    typingIntervalId = null;
                }
            }, 5);
        }

        // Function to stop the typing animation
        function stopTypingAnimation() {
            if (typingIntervalId) {
                clearInterval(typingIntervalId);
                typingIntervalId = null;
            }
            if (thinkingBubbleElement) {
                thinkingBubbleElement.remove();
                thinkingBubbleElement = null;
            }
        }
        
        // Function to show the thinking bubble
        function showThinkingBubble() {
            if (!thinkingBubbleElement) {
                thinkingBubbleElement = document.createElement('div');
                thinkingBubbleElement.classList.add('message', 'ai', 'thinking-bubble');
                thinkingBubbleElement.innerHTML = `
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                `;
                chatMessages.appendChild(thinkingBubbleElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Function to handle sending a message
        async function sendMessage(userText, isVoice=false) {
            if (userText.trim() === '') return;

            if (userText.trim() === UNLOCK_CODE) {
                unlimitedMessages = true;
                premiumEnabled = true;
                localStorage.setItem(PREMIUM_STATUS_KEY, 'true');
                displayMessage('ai', 'تم تفعيل وضع الرسائل غير المحدود بنجاح! استمتع بخدماتنا المتميزة.');
                updateMessageCounter();
                userInput.value = '';
                return;
            }

            if (!unlimitedMessages && remainingMessages <= 0) {
                displayMessage('ai', 'عذراً، لقد استنفدت عدد الرسائل اليومي. يمكنك الاشتراك في خدمة Premium للحصول على رسائل غير محدودة.');
                return;
            }

            const userProfileData = JSON.parse(localStorage.getItem(USER_PROFILE_KEY) || '{}');
            let profilePrompt = '';
            if (userProfileData.name || userProfileData.description) {
                profilePrompt += 'معلومات المستخدم:';
                if (userProfileData.name) {
                    profilePrompt += `\n- الاسم: ${userProfileData.name}`;
                }
                if (userProfileData.description) {
                    profilePrompt += `\n- الوصف: ${userProfileData.description}`;
                }
                profilePrompt += '\n\n';
            }
            
            const fullPrompt = profilePrompt + userText;
            displayMessage('user', userText);
            chatHistory.push({ role: "user", parts: [{ text: fullPrompt }] });
            userInput.value = '';

            showThinkingBubble();
            sendButton.style.display = 'none';
            stopButton.style.display = 'inline-flex';
            if (isVoice) {
                voiceChatButton.disabled = true;
                voiceChatButton.innerHTML = '<i class="fas fa-volume-up"></i> يرد الآن...';
            }

            abortController = new AbortController();
            const signal = abortController.signal;

            try {
                let parts = [{ text: fullPrompt }];
                if (uploadedImage) {
                    parts.unshift({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: uploadedImage
                        }
                    });
                }
                
                const payload = {
                    contents: [{
                        role: "user",
                        parts: parts
                    }]
                };

                const apiKey = "AIzaSyBl6P09eSlQ8lOxqG8tjc9gU-rlBFHGSXk";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: signal
                });

                const result = await response.json();
                const aiResponse = result.candidates[0].content.parts[0].text;

                stopTypingAnimation();
                if (thinkingBubbleElement) {
                    thinkingBubbleElement.remove();
                    thinkingBubbleElement = null;
                }
                
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                displayMessage('ai', aiResponse);
                saveChatHistory();
                removeImage();
                
                if (isVoice) {
                    await playTTS(aiResponse);
                }

                if (!unlimitedMessages) {
                    remainingMessages--;
                    updateMessageCounter();
                    saveMessageCount();
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request aborted by user');
                    stopTypingAnimation();
                    if (thinkingBubbleElement) {
                        thinkingBubbleElement.remove();
                        thinkingBubbleElement = null;
                    }
                    displayMessage('ai', 'تم إيقاف الرد.');
                } else {
                    console.error("API Error:", error);
                    stopTypingAnimation();
                    if (thinkingBubbleElement) {
                        thinkingBubbleElement.remove();
                        thinkingBubbleElement = null;
                    }
                    displayMessage('ai', 'عذراً، حدث خطأ أثناء الاتصال. يرجى المحاولة مرة أخرى.');
                }
            } finally {
                sendButton.style.display = 'inline-flex';
                stopButton.style.display = 'none';
                abortController = null;
                if (isVoice) {
                    voiceChatButton.disabled = false;
                    voiceChatButton.innerHTML = '<i class="fas fa-microphone"></i> تحدث صوتيًا';
                }
            }
        }
        
        let recognition = null;
        // Function to start speech recognition
        const startSpeechRecognition = async () => {
            if (voiceChatDuration >= MAX_VOICE_DURATION) {
                displayMessage('ai', 'عذراً، لقد استنفدت الوقت المخصص للدردشة الصوتية اليوم.');
                return;
            }

            if (!('webkitSpeechRecognition' in window)) {
                displayMessage('ai', 'عذراً، متصفحك لا يدعم خاصية التحدث الصوتي.');
                return;
            }

            try {
                // Check for microphone permission
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());

                if (recognition) {
                    recognition.stop();
                }
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'ar-EG';
                recognition.start();
                startVoiceTimer();

                userInput.placeholder = 'أنا أستمع... تحدث الآن.';
                voiceChatButton.innerHTML = '<i class="fas fa-microphone-slash"></i> أستمع...';
                voiceChatButton.classList.add('bg-red-500', 'hover:bg-red-600');
                isVoiceChatActive = true;
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    recognition.stop();
                    stopVoiceTimer();
                    sendMessage(transcript, true);
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceTimer();
                    userInput.placeholder = 'اكتب سؤالك عن الصحة أو اللياقة البدنية هنا...';
                    voiceChatButton.innerHTML = '<i class="fas fa-microphone"></i> تحدث صوتيًا';
                    voiceChatButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                    isVoiceChatActive = false;
                };

                recognition.onend = () => {
                    if(isVoiceChatActive) {
                        stopVoiceTimer();
                        userInput.placeholder = 'اكتب سؤالك عن الصحة أو اللياقة البدنية هنا...';
                        voiceChatButton.innerHTML = '<i class="fas fa-microphone"></i> تحدث صوتيًا';
                        voiceChatButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                    }
                };
            } catch (err) {
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    displayMessage('ai', 'عذراً، لم يتم منح الإذن لاستخدام الميكروفون. يرجى السماح للمتصفح بالوصول إلى الميكروفون لاستخدام هذه الميزة.');
                } else {
                    console.error('Microphone access error:', err);
                    displayMessage('ai', 'حدث خطأ في الوصول إلى الميكروفون. يرجى المحاولة مرة أخرى.');
                }
            }
        };

        // Function to stop the entire voice chat session and AI response
        const stopVoiceChatSession = () => {
            if (recognition) {
                recognition.stop();
                stopVoiceTimer();
            }
            if (ttsAudio) {
                ttsAudio.pause();
            }
            isVoiceChatActive = false;
            voiceChatButton.innerHTML = '<i class="fas fa-microphone"></i> تحدث صوتيًا';
            voiceChatButton.classList.remove('bg-red-500', 'hover:bg-red-600');
            userInput.placeholder = 'اكتب سؤالك عن الصحة أو اللياقة البدنية هنا...';
            // Abort the API call if it's in progress
            if (abortController) {
                abortController.abort();
            }
        };

        // Function to start the voice timer
        function startVoiceTimer() {
            if (voiceTimerInterval) clearInterval(voiceTimerInterval);
            voiceTimerInterval = setInterval(() => {
                voiceChatDuration++;
                updateVoiceTimerDisplay();
                localStorage.setItem(VOICE_DURATION_KEY, voiceChatDuration);
                if (voiceChatDuration >= MAX_VOICE_DURATION) {
                    stopVoiceChatSession();
                    displayMessage('ai', 'لقد استنفدت الوقت المخصص للدردشة الصوتية اليوم.');
                }
            }, 1000);
        }

        // Function to stop the voice timer
        function stopVoiceTimer() {
            clearInterval(voiceTimerInterval);
        }

        // Function to update the voice timer display
        function updateVoiceTimerDisplay() {
            const remaining = MAX_VOICE_DURATION - voiceChatDuration;
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            voiceTimerDisplay.textContent = `الوقت المتبقي للصوت: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            if (remaining <= 60 && remaining > 0) {
                voiceTimerDisplay.classList.add('text-yellow-500');
            } else if (remaining <= 0) {
                voiceTimerDisplay.classList.remove('text-yellow-500');
                voiceTimerDisplay.classList.add('text-red-500');
                voiceTimerDisplay.textContent = 'الوقت انتهى!';
            } else {
                voiceTimerDisplay.classList.remove('text-yellow-500', 'text-red-500');
            }
        }
        
        // Function to save chat history to localStorage
        function saveChatHistory() {
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatHistory));
        }

        // Function to load chat history from localStorage
        function loadChatHistory() {
            const savedChat = localStorage.getItem(CHAT_HISTORY_KEY);
            if (savedChat) {
                chatHistory = JSON.parse(savedChat);
                chatHistory.forEach(message => {
                    const messageElement = createMessageElement(message.role, message.parts[0].text);
                    chatMessages.appendChild(messageElement);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Function to clear chat history
        function clearChat() {
            const confirmed = window.confirm('هل أنت متأكد أنك تريد مسح المحادثة بالكامل؟');
            if (confirmed) {
                localStorage.removeItem(CHAT_HISTORY_KEY);
                chatHistory = [];
                chatMessages.innerHTML = '';
            }
        }
        
        // Function to suggest a random question
        function suggestQuestion() {
            const randomQuestion = randomQuestions[Math.floor(Math.random() * randomQuestions.length)];
            userInput.value = randomQuestion;
        }

        // Function to save message count and reset date
        function saveMessageCount() {
            localStorage.setItem(MESSAGE_COUNT_KEY, remainingMessages);
            const today = new Date().toDateString();
            localStorage.setItem(LAST_RESET_DATE_KEY, today);
        }

        // Function to load and update the message counter
        function updateMessageCounter() {
            premiumEnabled = localStorage.getItem(PREMIUM_STATUS_KEY) === 'true';
            
            const lastResetDate = localStorage.getItem(LAST_RESET_DATE_KEY);
            const today = new Date().toDateString();
            
            if (lastResetDate !== today) {
                remainingMessages = MAX_MESSAGES_PER_DAY;
                localStorage.setItem(LAST_RESET_DATE_KEY, today);
                localStorage.setItem(MESSAGE_COUNT_KEY, remainingMessages);
            } else {
                const savedCount = localStorage.getItem(MESSAGE_COUNT_KEY);
                if (savedCount !== null) {
                    remainingMessages = parseInt(savedCount, 10);
                }
            }
            
            if (premiumEnabled) {
                messageCounterDisplay.textContent = 'غير محدود';
            } else {
                messageCounterDisplay.textContent = remainingMessages;
            }
        }

        // Function to load and update voice duration
        function updateVoiceDuration() {
            const lastResetDate = localStorage.getItem(VOICE_LAST_RESET_DATE_KEY);
            const today = new Date().toDateString();
            
            if (lastResetDate !== today) {
                voiceChatDuration = 0;
                localStorage.setItem(VOICE_LAST_RESET_DATE_KEY, today);
                localStorage.setItem(VOICE_DURATION_KEY, voiceChatDuration);
            } else {
                const savedDuration = localStorage.getItem(VOICE_DURATION_KEY);
                if (savedDuration !== null) {
                    voiceChatDuration = parseInt(savedDuration, 10);
                }
            }
            updateVoiceTimerDisplay();
        }
        
        // Function to handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage = e.target.result.split(',')[1];
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Function to remove the uploaded image
        function removeImage() {
            uploadedImage = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            imageUploadInput.value = '';
        }

        // Function to handle profile save
        function saveProfile() {
            const name = profileNameInput.value.trim();
            const description = profileDescriptionTextarea.value.trim();
            const ttsVoice = ttsVoiceSelect.value;
            const userProfile = { name, description, ttsVoice };
            localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile));
            profileModal.style.display = 'none';
        }

        // Function to load profile data
        function loadProfile() {
            const userProfile = JSON.parse(localStorage.getItem(USER_PROFILE_KEY) || '{}');
            profileNameInput.value = userProfile.name || '';
            profileDescriptionTextarea.value = userProfile.description || '';
            ttsVoiceSelect.value = userProfile.ttsVoice || 'Puck';
        }

        // Function to handle saving notification settings
        function saveNotifications() {
            const waterHours = parseInt(waterHoursInput.value);
            const waterMinutes = parseInt(waterMinutesInput.value);
            const exerciseHours = parseInt(exerciseHoursInput.value);
            const exerciseMinutes = parseInt(exerciseMinutesInput.value);
            
            const waterInterval = (waterHours * 60 * 60 * 1000) + (waterMinutes * 60 * 1000);
            const exerciseInterval = (exerciseHours * 60 * 60 * 1000) + (exerciseMinutes * 60 * 1000);

            const settings = {
                waterInterval: waterInterval > 0 ? waterInterval : null,
                exerciseInterval: exerciseInterval > 0 ? exerciseInterval : null,
            };

            localStorage.setItem(NOTIFICATIONS_SETTINGS_KEY, JSON.stringify(settings));
            notificationsModal.style.display = 'none';
            setupNotifications();
        }

        // Function to load notification settings
        function loadNotificationsSettings() {
            const settings = JSON.parse(localStorage.getItem(NOTIFICATIONS_SETTINGS_KEY) || '{}');
            if (settings.waterInterval) {
                const hours = Math.floor(settings.waterInterval / (1000 * 60 * 60));
                const minutes = (settings.waterInterval % (1000 * 60 * 60)) / (1000 * 60);
                waterHoursInput.value = hours;
                waterMinutesInput.value = minutes;
            } else {
                waterHoursInput.value = '';
                waterMinutesInput.value = '';
            }
            if (settings.exerciseInterval) {
                const hours = Math.floor(settings.exerciseInterval / (1000 * 60 * 60));
                const minutes = (settings.exerciseInterval % (1000 * 60 * 60)) / (1000 * 60);
                exerciseHoursInput.value = hours;
                exerciseMinutesInput.value = minutes;
            } else {
                exerciseHoursInput.value = '';
                exerciseMinutesInput.value = '';
            }
        }

        // Function to check for and send notifications
        function setupNotifications() {
            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            }

            // Clear existing intervals
            for (const key in notificationIntervals) {
                clearInterval(notificationIntervals[key]);
            }

            const settings = JSON.parse(localStorage.getItem(NOTIFICATIONS_SETTINGS_KEY) || '{}');
            
            if (settings.waterInterval) {
                notificationIntervals.water = setInterval(() => {
                    if (Notification.permission === 'granted') {
                        new Notification('FitnessUp Pro', {
                            body: 'تذكير: حان وقت شرب الماء!',
                        });
                    }
                }, settings.waterInterval);
            }

            if (settings.exerciseInterval) {
                notificationIntervals.exercise = setInterval(() => {
                    if (Notification.permission === 'granted') {
                        new Notification('FitnessUp Pro', {
                            body: 'تذكير: قم ببعض التمارين الخفيفة الآن!',
                        });
                    }
                }, settings.exerciseInterval);
            }
        }


        // Event listeners
        sendButton.addEventListener('click', () => sendMessage(userInput.value));
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage(userInput.value);
            }
        });
        stopButton.addEventListener('click', stopVoiceChatSession);
        backButton.addEventListener('click', () => {
            window.location.href = 'home.html';
        });
        clearChatButton.addEventListener('click', clearChat);
        suggestQuestionButton.addEventListener('click', suggestQuestion);
        imageUploadButton.addEventListener('click', () => {
             imageUploadInput.click();
        });
        imageUploadInput.addEventListener('change', handleImageUpload);
        removeImageButton.addEventListener('click', removeImage);

        // Event listeners for new features
        voiceChatButton.addEventListener('click', () => {
            if (isVoiceChatActive) {
                stopVoiceChatSession();
            } else {
                startSpeechRecognition();
            }
        });
        notificationsButton.addEventListener('click', () => {
            loadNotificationsSettings();
            notificationsModal.style.display = 'flex';
        });
        profileButton.addEventListener('click', () => {
            loadProfile();
            profileModal.style.display = 'flex';
        });
        closeProfileModalButton.addEventListener('click', () => {
            profileModal.style.display = 'none';
        });
        saveProfileButton.addEventListener('click', saveProfile);
        closeNotificationsModalButton.addEventListener('click', () => {
            notificationsModal.style.display = 'none';
        });
        saveNotificationsButton.addEventListener('click', saveNotifications);


        // On page load
        window.onload = function() {
            loadChatHistory();
            updateMessageCounter();
            updateVoiceDuration();
            if (chatHistory.length === 0) {
                setTimeout(() => {
                    const welcomeMessage = 'مرحباً بك في FitnessUp Pro! أنا **مستشارك الشخصي في الصحة واللياقة البدنية**. يسعدني أن أقدم لك استشارات طبية ونصائح رياضية لمساعدتك في تحقيق أهدافك. كيف يمكنني مساعدتك اليوم؟';
                    displayMessage('ai', welcomeMessage);
                    chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
                    saveChatHistory();
                }, 500);
            }
            setupNotifications();
            if (localStorage.getItem(PREMIUM_STATUS_KEY) === 'true') {
                unlimitedMessages = true;
            }
        };

        // Offline event listener
        window.addEventListener('offline', () => {
            console.log("Internet connection lost! Redirecting to offline page.");
            // You may need to create an offline.html page or show a custom message.
            // window.location.href = 'offline.html';
        });
    </script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        marked.setOptions({
            breaks: true,
            gfm: true,
        });
    </script>
</body>
</html>
