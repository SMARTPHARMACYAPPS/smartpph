<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART PPH - لياقة الوزن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6; /* خلفية رمادية فاتحة */
            color: #333;
            direction: rtl;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1.5rem; /* مسافة داخلية للصفحة */
        }
        /* أنماط مخصصة لأزرار الراديو */
        .custom-radio input[type="radio"] {
            display: none;
        }
        .custom-radio label {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem; /* حواف مستديرة */
            padding: 0.75rem 1.5rem; /* مسافة داخلية */
            cursor: pointer;
            border: 1px solid #d1d5db; /* حدود رمادية */
        }
        .custom-radio input[type="radio"]:checked + label {
            background-color: #2563eb; /* أزرق عند الاختيار */
            color: white;
            border-color: #2563eb;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3); /* ظل خفيف */
        }
        .custom-radio label:hover {
            background-color: #e5e7eb; /* رمادي أفتح عند التحويم */
        }
        .custom-radio input[type="radio"]:checked + label:hover {
            background-color: #1d4ed8; /* أزرق أغمق عند التحويم والاختيار */
        }

        /* أنماط عامة للعناصر التفاعلية */
        input, select, textarea, button {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.4);
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* أنماط خاصة بالتقرير المطبوع (PDF) */
        @media print {
            body {
                background-color: #ffffff !important;
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none !important;
            }
            /* Style for the receipt-like print */
            .receipt-print-area {
                width: 72mm; /* Thermal printer width */
                padding: 4mm;
                font-family: 'Cairo', sans-serif;
                color: #000;
                direction: rtl;
                box-sizing: border-box;
                margin: 0 auto; /* Center for A4 print preview */
            }
            .receipt-print-area h1, .receipt-print-area h2, .receipt-print-area h3 {
                color: #000 !important;
                font-weight: bold !important;
            }
            .receipt-print-area p, .receipt-print-area span, .receipt-print-area label {
                color: #000 !important;
            }
            .receipt-print-area .logo-placeholder-print {
                width: 50mm; /* Adjust logo size for receipt */
                height: auto;
                display: block;
                margin: 0 auto 5mm;
            }
            .receipt-print-area .divider {
                border-top: 1px dashed #000;
                margin: 5mm 0;
            }
            /* In print, textarea should not have border or padding */
            .receipt-print-area textarea {
                border: none !important;
                resize: none;
                width: 100%;
                min-height: 30mm;
                font-family: 'Cairo', sans-serif;
                color: #000;
                text-align: right;
                padding: 0 !important;
            }
        }

        /* Modal Styles (copied from pph.txt to ensure consistency) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0; /* Start hidden for animation */
            visibility: hidden; /* Hide from screen readers/interaction */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            transform: translateY(-20px); /* Start slightly above for animation */
            transition: transform 0.3s ease-in-out;
        }
        .modal.visible .modal-content {
            transform: translateY(0); /* Slide into place */
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #333;
            transition: transform 0.2s ease-in-out;
        }
        .modal-close-button:hover {
            transform: scale(1.2);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        /* Styles for receipt in modal (from pph.txt) */
        .receipt-container {
            width: 72mm; /* Thermal printer width */
            padding: 4mm;
            font-family: 'Cairo', sans-serif;
            color: #000;
            direction: rtl;
            box-sizing: border-box;
            margin: 0 auto; /* Center for A4 print preview */
        }
        .receipt-container h1, .receipt-container h2, .receipt-container h3 {
            color: #000 !important;
            font-weight: bold !important;
        }
        .receipt-container p, .receipt-container span, .receipt-container label {
            color: #000 !important;
        }
        .receipt-container .logo-placeholder {
            width: 50mm; /* Adjust logo size for receipt */
            height: auto;
            display: block;
            margin: 0 auto 5mm;
        }
        .receipt-container .divider {
            border-top: 1px dashed #000;
            margin: 5mm 0;
        }
        /* In modal, textarea should have border and padding for display */
        .receipt-container textarea {
            border: 1px dashed #ccc;
            resize: none;
            width: 100%;
            min-height: 30mm;
            font-family: 'Cairo', sans-serif;
            color: #000;
            text-align: right;
            padding: 5px;
            box-sizing: border-box;
        }

        /* Loading Spinner Styles */
        #loadingSpinner {
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            color: white;
            flex-direction: column;
        }
        #loadingSpinner.hidden {
            display: none;
        }
        #loadingSpinner svg {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Food Database Modal specific styles */
        #foodDatabaseModal .modal-content {
            max-width: 600px;
            width: 90%;
        }
        #foodDatabaseList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #foodDatabaseList li {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #foodDatabaseList li:last-child {
            border-bottom: none;
        }
        #foodDatabaseList li span:first-child {
            font-weight: bold;
            color: #333;
        }
        #foodDatabaseList li span:last-child {
            color: #666;
            font-size: 0.9em;
        }
        
        /* CSS for the Floating Button */
        .floating-button {
            position: fixed; /* يجعل الزر عائمًا بالنسبة لإطار العرض */
            bottom: 30px;    /* المسافة من أسفل الشاشة */
            left: 30px;      /* المسافة من يسار الشاشة */
            z-index: 1000;   /* يضمن بقاءه فوق المحتوى الآخر */
            width: 70px;     /* عرض الدائرة */
            height: 70px;    /* ارتفاع الدائرة */
            background-color: #000000; /* خلفية سوداء */
            border-radius: 50%; /* يجعلها دائرة مثالية */
            display: flex;   /* استخدام فليكس بوكس لتوسيط المحتوى بالداخل */
            flex-direction: column; /* ترتيب المحتوى (النجمة والنص) عموديًا */
            justify-content: center; /* توسيط عمودي */
            align-items: center; /* توسيط أفقي */
            gap: 2px; /* مسافة صغيرة بين النجمة والنص */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); /* ظل خفيف للعمق */
            text-decoration: none; /* إزالة الخط السفلي من الرابط */
            transition: background-color 0.3s ease, transform 0.3s ease; /* انتقالات سلسة */
            cursor: pointer; /* للإشارة إلى أنه قابل للنقر */
            overflow: hidden; /* لإخفاء الوجه عندما يكون خارج الدائرة */
        }

        .floating-button:hover {
            background-color: #333333; /* لون أسود أفتح قليلاً عند التمرير */
            transform: scale(1.05); /* تكبير طفيف عند التمرير */
        }

        .floating-button-icon {
            font-size: 32px; /* حجم أيقونة النجمة */
            color: #FFD700; /* لون ذهبي للنجمة */
            line-height: 1; /* لضمان توسيط الأيقونة عموديًا */
            display: block; /* لضمان أن الأيقونة تأخذ مساحة كافية للحركة */
            transition: transform 0.3s ease, filter 0.3s ease; /* انتقالات سلسة للتحريك واللمعان */
            position: relative; /* للسماح بالقفز */
            z-index: 2; /* فوق الوجه */
        }

        .floating-button-text {
            font-size: 10px; /* حجم نص "PPH AI" */
            color: #e0e7ff; /* لون النص */
            font-weight: 600;
            line-height: 1; /* لضمان توسيط النص عموديًا */
            text-transform: uppercase; /* لجعل النص أحرفًا كبيرة */
            z-index: 2; /* فوق الوجه */
        }

        /* Animation for the star icon on hover */
        .floating-button-icon.jump-animation {
            animation: starJump 0.9s ease-in-out 3 forwards; /* تقفز 3 مرات */
        }

        .floating-button-icon.glow-animation {
            animation: starGlow 0.99s ease-in-out forwards; /* تلمع مرة واحدة */
        }

        @keyframes starJump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); } /* قفزة لأعلى */
        }

        @keyframes starGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(2.5); /* لمعان ساطع جداً */ }
        }

        /* Face Overlay Styles */
        .face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: transparent; /* خلفية شفافة */
            opacity: 0; /* مخفي افتراضياً */
            transform: scale(0); /* مخفي افتراضياً */
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 3; /* فوق النجمة والنص */
        }

        .face-overlay.visible {
            opacity: 1;
            transform: scale(1);
        }

        .face-eye {
            width: 8px;
            height: 8px;
            background-color: #ffffff;
            border-radius: 50%;
            position: absolute;
            top: 25px;
        }
        .face-eye.left-eye { left: 20px; }
        .face-eye.right-eye { right: 20px; }

        .face-mouth {
            width: 30px;
            height: 15px;
            background-color: #ffffff;
            border-radius: 0 0 15px 15px; /* ابتسامة */
            position: absolute;
            bottom: 20px;
            transition: all 0.2s ease-in-out;
        }

        /* Face Animations */
        .face-overlay.face-appear {
            animation: faceAppear 0.3s ease-out forwards;
        }
        @keyframes faceAppear {
            0% { opacity: 0; transform: scale(0); }
            100% { opacity: 1; transform: scale(1); }
        }

        .face-overlay.face-smile .face-mouth {
            animation: faceSmile 0.4s ease-in-out forwards;
        }
        @keyframes faceSmile {
            0% { transform: scale(1); }
            50% { transform: scale(1.2, 0.8); } /* ابتسامة عريضة */
            100% { transform: scale(1); }
        }

        .face-overlay.face-wave {
            animation: faceWave 0.5s ease-in-out forwards;
        }
        @keyframes faceWave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }

        .face-overlay.face-disappear {
            animation: faceDisappear 0.9s ease-in forwards;
        }
        @keyframes faceDisappear {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 600px) {
            .floating-button {
                width: 60px; /* حجم معدل للشاشات الأصغر */
                height: 60px; /* حجم معدل للشاشات الأصغر */
                bottom: 20px;
                left: 20px;
            }
            .floating-button-icon {
                font-size: 28px; /* حجم أيقونة معدل للشاشات الأصغر */
            }
            .floating-button-text {
                font-size: 9px; /* حجم نص معدل للشاشات الأصغر */
            }
            .face-eye {
                width: 7px;
                height: 7px;
                top: 22px;
            }
            .face-eye.left-eye { left: 18px; }
            .face-eye.right-eye { right: 18px; }
            .face-mouth {
                width: 25px;
                height: 12px;
                bottom: 18px;
            }
        }
    
    </style>
</head>
<body>
    <!-- زر العودة للصفحة الرئيسية -->
    <button id="backToHomeBtn" class="absolute top-4 right-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        العودة للرئيسية
    </button>

    <!-- حاوية رئيسية للصفحة -->
    <div class="container bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl no-print">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">حاسبة لياقة الوزن</h1>
        <p class="text-gray-600 text-center mb-6"> احسب سعراتك الحرارية اليومية واحصل على خطة مقترحة للوجبات والتمارين. واذا اردت نتيجة افضل اسأل ذكائنا الاصطناعي الجديد!</p>

        <!-- قسم إدخال البيانات -->
        <div class="mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">أدخل بياناتك:</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="weightInput" class="block text-gray-700 text-sm font-bold mb-2">الوزن (كجم):</label>
                    <input type="number" id="weightInput" placeholder="مثال: 70"
                        class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="heightInput" class="block text-gray-700 text-sm font-bold mb-2">الطول (سم):</label>
                    <input type="number" id="heightInput" placeholder="مثال: 175"
                        class="w-full p-3 border border-gray-300 rounded-lg">
                    <div class="mt-2 flex items-center">
                        <input type="checkbox" id="skipHeightCheckbox" class="ml-2">
                        <label for="skipHeightCheckbox" class="text-gray-600 text-sm">لا أريد إضافة الطول (سيتم استخدام تقدير)</label>
                    </div>
                </div>
            </div>
<!-- HTML for the Floating Button -->
<a href="fitnessupgiminiai.html" class="floating-button" aria-label="Go to Fitness Up Giminiai page" id="floatingButton">
    <span class="floating-button-icon" id="floatingButtonIcon">✦</span>
    <span class="floating-button-text">PPH AI</span>
    <!-- Face Overlay (initially hidden) -->
    <div class="face-overlay" id="faceOverlay">
        <div class="face-eye left-eye"></div>
        <div class="face-eye right-eye"></div>
        <div class="face-mouth"></div>
    </div>
</a>

            <div class="mb-4">
                <label for="ageInput" class="block text-gray-700 text-sm font-bold mb-2">العمر (سنة):</label>
                <input type="number" id="ageInput" placeholder="مثال: 30"
                    class="w-full p-3 border border-gray-300 rounded-lg">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">الجنس:</label>
                <div class="flex justify-around custom-radio">
                    <input type="radio" id="genderMale" name="gender" value="male" checked>
                    <label for="genderMale">ذكر</label>
                    <input type="radio" id="genderFemale" name="gender" value="female">
                    <label for="genderFemale">أنثى</label>
                </div>
            </div>

            <div class="mb-6">
                <label for="activityLevel" class="block text-gray-700 text-sm font-bold mb-2">مستوى النشاط البدني:</label>
                <select id="activityLevel" class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="sedentary">قليل النشاط (عمل مكتبي، لا تمارين)</option>
                    <option value="light">نشاط خفيف (تمارين 1-3 أيام/أسبوع)</option>
                    <option value="moderate">نشاط متوسط (تمارين 3-5 أيام/أسبوع)</option>
                    <option value="active">نشاط عالٍ (تمارين 6-7 أيام/أسبوع)</option>
                    <option value="very_active">نشاط مرتفع جدًا (تمارين مكثفة يومياً)</option>
                </select>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">الهدف:</label>
                <div class="flex justify-around custom-radio">
                    <input type="radio" id="goalLose" name="goal" value="lose" checked>
                    <label for="goalLose" class="bg-red-100 text-red-700 hover:bg-red-200">إنقاص الوزن</label>
                    <input type="radio" id="goalMaintain" name="goal" value="maintain">
                    <label for="goalMaintain" class="bg-green-100 text-green-700 hover:bg-green-200">الحفاظ على الوزن</label>
                    <input type="radio" id="goalGain" name="goal" value="gain">
                    <label for="goalGain" class="bg-blue-100 text-blue-700 hover:bg-blue-200">زيادة الوزن</label>
                </div>
            </div>

            <button id="calculateCaloriesBtn"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l-2 2H5V6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v10a2 2 0 01-2 2H9z" />
                </svg>
                حساب السعرات الحرارية والخطة
            </button>
        </div>

        <!-- قسم عرض النتائج (لم يعد مخفيا بشكل افتراضي) -->
        <div id="fitnessResults" class="mt-8 p-6 border border-blue-200 rounded-lg bg-blue-50">
            <h2 class="text-2xl font-bold text-blue-800 mb-4 text-center">نتائج خطتك الشخصية:</h2>

            <p class="text-gray-700 text-lg mb-4">
                <span class="font-bold">الوزن:</span> <span id="displayWeight" class="font-semibold text-blue-600">---</span> كجم
            </p>
            <p class="text-700 text-lg mb-4">
                <span class="font-bold">الطول:</span> <span id="displayHeight" class="font-semibold text-blue-600">---</span> سم <span id="heightEstimateNote" class="text-sm text-gray-500 italic hidden">(تقديري)</span>
            </p>
            <p class="text-gray-700 text-lg mb-4">
                <span class="font-bold">العمر:</span> <span id="displayAge" class="font-semibold text-blue-600">---</span> سنة
            </p>
            <p class="text-gray-700 text-lg mb-4">
                <span class="font-bold">السعرات الحرارية المقترحة يومياً:</span> <span id="dailyCalories" class="font-bold text-blue-800 text-2xl">---</span> سعرة حرارية
            </p>
            <p class="text-gray-700 text-lg mb-4">
                <span class="font-bold">إجمالي سعرات الوجبات المقترحة:</span> <span id="totalMealsCalories" class="font-bold text-blue-800 text-xl">---</span> سعرة حرارية
            </p>

            <div id="dietPlan" class="mt-6 p-4 bg-white rounded-lg shadow-sm">
                <h3 class="font-bold text-xl text-gray-800 mb-3">خطة الوجبات المقترحة:</h3>
                <ul class="list-disc list-inside text-gray-700 text-lg leading-relaxed space-y-2">
                    <!-- Meal suggestions will be dynamically inserted here -->
                </ul>
            </div>

            <div id="exerciseTips" class="mt-6 p-4 bg-white rounded-lg shadow-sm">
                <h3 class="font-bold text-xl text-gray-800 mb-3">تمارين مقترحة:</h3>
                <ul class="list-disc list-inside text-gray-700 text-lg leading-relaxed space-y-2">
                    <!-- Exercise suggestions will be dynamically inserted here -->
                </ul>
            </div>

            <div id="generalTips" class="mt-6 p-4 bg-white rounded-lg shadow-sm">
                <h3 class="font-bold text-xl text-gray-800 mb-3">نصائح إضافية لنمط حياة صحي:</h3>
                <ul class="list-disc list-inside text-gray-700 text-lg leading-relaxed space-y-2">
                    <!-- General tips will be dynamically inserted here -->
                </ul>
            </div>

            <!-- حقل الملاحظات الإضافية -->
            <div class="mb-6 mt-6">
                <label for="notesInput" class="block text-gray-700 text-sm font-bold mb-2">ملاحظات إضافية (اختياري):</label>
                <textarea id="notesInput" rows="3" placeholder="أضف أي ملاحظات هنا..."
                    class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
            </div>

            <!-- زر نسخ تقرير لياقة الوزن (كان تحميل TXT) -->
            <button id="copyFitnessReportTxtBtn"
                class="mt-8 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5v2m0-2h2m4 0h2M9 8h6m-3 3v6m-3-3h6" />
                </svg>
                نسخ تقرير لياقة الوزن
            </button>

            <!-- زر تقرير لياقة الوزن (لتحميل Word) -->
            <button id="generateFitnessReportWordBtn"
                class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                تحميل تقرير لياقة الوزن (Word)
            </button>

            <!-- زر قاعدة بيانات الأكل -->
            <button id="openFoodDatabaseBtn"
                class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10a2 2 0 002 2h12a2 2 0 002-2V7m-4 3v4m-4-4v4m-4-4v4M4 7h16a2 2 0 002-2V4a2 2 0 00-2-2H4a2 2 0 00-2 2v3a2 2 0 002 2z" />
                </svg>
                قاعدة بيانات الأكل
            </button>

            <!-- زر طباعة إيصال لياقة الوزن -->
            <button id="printFitnessReceiptBtn"
                class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                طباعة إيصال لياقة الوزن
            </button>
        </div>
    </div>

    <!-- Modal لمعاينة إيصال لياقة الوزن -->
    <div id="fitnessReceiptPreviewModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" onclick="window.closeFitnessReceiptPreviewModal()">×</button>
            <div class="modal-title">معاينة إيصال لياقة الوزن</div>
            <!-- سيتم نسخ محتوى الإيصال هنا ديناميكياً -->
            <div id="modalFitnessReceiptContent" class="receipt-container bg-white rounded-lg shadow-lg">
                <!-- Receipt content will be dynamically inserted here -->
            </div>
            <div class="modal-print-button-container text-center mt-4 flex justify-center space-x-4">
                <button onclick="window.printFitnessReceiptFromModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    طباعة الإيصال
                </button>
            </div>
        </div>
    </div>

    <!-- Modal لقاعدة بيانات الأكل -->
    <div id="foodDatabaseModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" onclick="window.closeFoodDatabaseModal()">×</button>
            <div class="modal-title">قاعدة بيانات الأكل (سعرات حرارية تقريبية)</div>
            <ul id="foodDatabaseList" class="text-right">
                <!-- Food items will be dynamically inserted here -->
            </ul>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg">جاري توليد التقرير...</p>
    </div>

    <script>
        // مفتاح لتخزين بيانات الصيدلية في localStorage (يجب أن يتطابق مع pph.html)
        const LOCAL_STORAGE_KEY = 'pharmacy_data_v1';

        // Pharmacy data object (will be loaded from localStorage)
        let pharmacyData = {
            name: 'اسم الصيدلية',
            address: 'العنوان',
            phone: 'رقم الهاتف',
            logoUrl: 'https://placehold.co/150x150/d1d5db/9ca3af?text=شعار' // Placeholder logo
        };

        // Function to load pharmacy data from localStorage
        function loadPharmacyData() {
            const savedPharmacyData = localStorage.getItem(LOCAL_STORAGE_KEY); // Use correct key
            if (savedPharmacyData) {
                try {
                    const parsedData = JSON.parse(savedPharmacyData);
                    // Only update if parsedData is valid and has expected properties
                    if (parsedData && parsedData.name && parsedData.address && parsedData.phone) {
                        pharmacyData = parsedData;
                        // If logoUrl is empty or null, use a default placeholder or ensure it's handled
                        if (!pharmacyData.logoUrl) {
                            pharmacyData.logoUrl = 'https://placehold.co/150x150/d1d5db/9ca3af?text=شعار';
                        }
                        console.log('Pharmacy data loaded from localStorage:', pharmacyData);
                    }
                } catch (e) {
                    console.error('Error parsing pharmacy data from localStorage:', e);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load pharmacy data on page load
            loadPharmacyData();

            // عناصر الإدخال
            const weightInput = document.getElementById('weightInput');
            const heightInput = document.getElementById('heightInput');
            const skipHeightCheckbox = document.getElementById('skipHeightCheckbox');
            const ageInput = document.getElementById('ageInput');
            const genderRadios = document.querySelectorAll('input[name="gender"]');
            const activityLevelSelect = document.getElementById('activityLevel');
            const goalRadios = document.querySelectorAll('input[name="goal"]');
            const calculateCaloriesBtn = document.getElementById('calculateCaloriesBtn');
            const copyFitnessReportTxtBtn = document.getElementById('copyFitnessReportTxtBtn'); // Changed ID
            const generateFitnessReportWordBtn = document.getElementById('generateFitnessReportWordBtn'); // New button
            const openFoodDatabaseBtn = document.getElementById('openFoodDatabaseBtn'); // New button for food database
            const printFitnessReceiptBtn = document.getElementById('printFitnessReceiptBtn');
            const backToHomeBtn = document.getElementById('backToHomeBtn');

            // عناصر عرض النتائج
            const fitnessResultsDiv = document.getElementById('fitnessResults');
            const displayWeightSpan = document.getElementById('displayWeight');
            const displayHeightSpan = document.getElementById('displayHeight');
            const heightEstimateNoteSpan = document.getElementById('heightEstimateNote');
            const displayAgeSpan = document.getElementById('displayAge');
            const dailyCaloriesSpan = document.getElementById('dailyCalories');
            const totalMealsCaloriesSpan = document.getElementById('totalMealsCalories'); // New span for total meal calories
            const dietPlanUl = document.querySelector('#dietPlan ul');
            const exerciseTipsUl = document.querySelector('#exerciseTips ul');
            const generalTipsUl = document.querySelector('#generalTips ul');
            const notesInput = document.getElementById('notesInput');

            // عناصر المودال الجديدة
            const fitnessReceiptPreviewModal = document.getElementById('fitnessReceiptPreviewModal');
            const modalFitnessReceiptContent = document.getElementById('modalFitnessReceiptContent');
            const foodDatabaseModal = document.getElementById('foodDatabaseModal'); // Food database modal
            const foodDatabaseList = document.getElementById('foodDatabaseList'); // List inside food database modal
            const loadingSpinner = document.getElementById('loadingSpinner');

            // تهيئة المحتوى عند التحميل ليكون فارغًا ولكن مرئيًا
            displayWeightSpan.textContent = '---';
            displayHeightSpan.textContent = '---';
            displayAgeSpan.textContent = '---';
            dailyCaloriesSpan.textContent = '---';
            totalMealsCaloriesSpan.textContent = '---'; // Initialize new span
            dietPlanUl.innerHTML = '<li>الرجاء إدخال بياناتك لحساب خطة الوجبات.</li>';
            exerciseTipsUl.innerHTML = '<li>الرجاء إدخال بياناتك للحصول على اقتراحات التمارين.</li>';
            generalTipsUl.innerHTML = '<li>الرجاء إدخال بياناتك للحصول على نصائح عامة.</li>';


            // إضافة مستمع حدث لزر الحساب
            calculateCaloriesBtn.addEventListener('click', calculateCaloriesAndSuggestions);

            // إضافة مستمع حدث لزر نسخ التقرير TXT
            copyFitnessReportTxtBtn.addEventListener('click', copyReportToClipboard); // Changed function call

            // إضافة مستمع حدث لزر تحميل التقرير Word
            generateFitnessReportWordBtn.addEventListener('click', generateAndDownloadWordReport); // New function call

            // إضافة مستمع حدث لزر قاعدة بيانات الأكل
            openFoodDatabaseBtn.addEventListener('click', openFoodDatabaseModal); // New function call

            // إضافة مستمع حدث لزر طباعة الإيصال (الآن يفتح نافذة المعاينة)
            printFitnessReceiptBtn.addEventListener('click', openFitnessReceiptPreviewModal);

            // إضافة مستمع حدث لزر العودة للصفحة الرئيسية
            backToHomeBtn.addEventListener('click', () => {
                window.location.href = 'index.html'; // تأكد من أن هذا هو المسار الصحيح لصفحتك الرئيسية
            });

            // مستمع حدث لزر "لا أريد إضافة الطول"
            skipHeightCheckbox.addEventListener('change', () => {
                if (skipHeightCheckbox.checked) {
                    heightInput.value = ''; // مسح قيمة الطول
                    heightInput.disabled = true; // تعطيل حقل الطول
                    heightInput.placeholder = 'سيتم استخدام تقدير';
                } else {
                    heightInput.disabled = false; // تفعيل حقل الطول
                    heightInput.placeholder = 'مثال: 175';
                }
            });

            /**
             * دالة لحساب السعرات الحرارية وتقديم الاقتراحات بناءً على بيانات المستخدم.
             */
            function calculateCaloriesAndSuggestions() {
                const weight = parseFloat(weightInput.value);
                let height = parseFloat(heightInput.value);
                const age = parseFloat(ageInput.value);
                const gender = document.querySelector('input[name="gender"]:checked')?.value;
                const activity = activityLevelSelect.value;
                const goal = document.querySelector('input[name="goal"]:checked')?.value;

                let isHeightEstimated = false;

                // التحقق من صحة المدخلات
                if (isNaN(weight) || weight <= 0) {
                    alert('الرجاء إدخال الوزن بشكل صحيح.');
                    return;
                }
                if (isNaN(age) || age <= 0) {
                    alert('الرجاء إدخال العمر بشكل صحيح.');
                    return;
                }
                if (!gender || !activity || !goal) {
                    alert('الرجاء تحديد الجنس ومستوى النشاط والهدف.');
                    return;
                }

                // معالجة خيار "لا أريد إضافة الطول"
                if (skipHeightCheckbox.checked || isNaN(height) || height <= 0) {
                    if (gender === 'male') {
                        height = 175; // متوسط طول الرجل بالسنتيمتر
                    } else { // female
                        height = 162; // متوسط طول المرأة بالسنتيمتر
                    }
                    isHeightEstimated = true;
                }

                // حساب السعرات الحرارية الأساسية (BMR) باستخدام Mifflin-St Jeor Equation
                let bmr;
                if (gender === 'male') {
                    bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
                } else { // female
                    bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
                }

                // معاملات مستوى النشاط (PAL - Physical Activity Level)
                const activityFactors = {
                    'sedentary': 1.2,
                    'light': 1.375,
                    'moderate': 1.55,
                    'active': 1.725,
                    'very_active': 1.9
                };

                // حساب إجمالي السعرات الحرارية اليومية (TDEE)
                let tdee = bmr * activityFactors[activity];

                // تعديل السعرات الحرارية حسب الهدف
                let targetCalories;
                if (goal === 'lose') {
                    targetCalories = tdee - 500; // عجز 500 سعرة حرارية لإنقاص حوالي 0.5 كجم/أسبوع
                } else if (goal === 'gain') {
                    targetCalories = tdee + 500; // زيادة 500 سعرة حرارية لزيادة حوالي 0.5 كجم/أسبوع
                } else { // maintain
                    targetCalories = tdee;
                }

                // عرض النتائج في الواجهة
                displayWeightSpan.textContent = weight;
                displayAgeSpan.textContent = age;
                displayHeightSpan.textContent = height; // عرض الطول (سواء كان مدخل أو مقدر)
                if (isHeightEstimated) {
                    heightEstimateNoteSpan.classList.remove('hidden'); // إظهار ملاحظة التقدير
                } else {
                    heightEstimateNoteSpan.classList.add('hidden'); // إخفاء ملاحظة التقدير
                }
                dailyCaloriesSpan.textContent = Math.round(targetCalories);

                // تحديث خطة الوجبات والتمارين والنصائح
                updateDietPlan(Math.round(targetCalories), goal);
                updateExerciseTips(activity, goal, height, age, gender); // تمرير الطول والعمر والجنس
                updateGeneralTips();
            }

            // بيانات الوجبات المحسنة (يمكن توسيعها بشكل أكبر)
            const mealData = {
                breakfast: [
                    { name: 'شوفان بالحليب والمكسرات والفواكه', calories: 400 },
                    { name: 'بيض أومليت بالخضروات مع شريحة توست أسمر', calories: 350 },
                    { name: 'زبادي يوناني مع توت وبذور الشيا', calories: 280 },
                    { name: 'ساندويتش جبنة قريش وخيار', calories: 220 }
                ],
                snack: [
                    { name: 'تفاحة مع قليل من زبدة الفول السوداني', calories: 200 },
                    { name: 'حفنة لوز أو عين جمل', calories: 150 },
                    { name: 'زبادي يوناني قليل الدسم', calories: 140 },
                    { name: 'خضروات مقطعة (جزر، خيار) مع حمص', calories: 100 },
                    { name: 'برتقالة', calories: 80 }
                ],
                lunch: [
                    { name: 'صدر دجاج مشوي (150 جرام) مع أرز أسمر وسلطة خضراء كبيرة', calories: 550 },
                    { name: 'سمك مخبوز مع بطاطا حلوة وخضروات مطهوة على البخار', calories: 500 },
                    { name: 'طبق بقوليات (عدس/فاصوليا) مع خبز أسمر وسلطة', calories: 450 },
                    { name: 'سلطة كينوا بالدجاج والخضروات', calories: 480 }
                ],
                dinner: [
                    { name: 'شوربة خضار مع قطعة صغيرة من البروتين الخالي من الدهون (دجاج/سمك)', calories: 350 },
                    { name: 'سلطة تونة أو دجاج مع الكثير من الخضروات الورقية', calories: 300 },
                    { name: 'جبن قريش مع طماطم وخيار وزيت زيتون', calories: 250 },
                    { name: 'خضروات سوتيه مع قطعة لحم أحمر قليل الدهن', calories: 400 }
                ]
            };

            /**
             * دالة لاختيار وجبة عشوائية من قائمة معينة مع مراعاة السعرات الحرارية المستهدفة.
             * @param {Array<Object>} mealsArray - مصفوفة الوجبات للاختيار منها.
             * @param {number} targetCalsForMeal - السعرات الحرارية المستهدفة لهذه الوجبة.
             * @returns {{name: string, calories: number}} - الوجبة المختارة (الاسم والسعرات).
             */
            function getSmartMeal(mealsArray, targetCalsForMeal) {
                // فرز الوجبات بناءً على مدى قرب سعراتها من السعرات المستهدفة
                mealsArray.sort((a, b) =>
                    Math.abs(a.calories - targetCalsForMeal) - Math.abs(b.calories - targetCalsForMeal)
                );
                // اختيار الوجبة الأقرب للسعرات المستهدفة
                return mealsArray[0];
            }

            /**
             * دالة لتحديث خطة الوجبات المقترحة.
             * @param {number} totalCalories - السعرات الحرارية الإجمالية المستهدفة يومياً.
             * @param {string} goal - هدف المستخدم (lose, maintain, gain).
             */
            function updateDietPlan(totalCalories, goal) {
                // توزيع تقريبي للسعرات الحرارية على الوجبات
                let breakfastCals, snack1Cals, lunchCals, snack2Cals, dinnerCals;

                if (goal === 'lose') {
                    breakfastCals = totalCalories * 0.25; // 25%
                    snack1Cals = totalCalories * 0.10; // 10%
                    lunchCals = totalCalories * 0.30; // 30%
                    snack2Cals = totalCalories * 0.10; // 10%
                    dinnerCals = totalCalories * 0.25; // 25%
                } else if (goal === 'gain') {
                    breakfastCals = totalCalories * 0.20; // 20%
                    snack1Cals = totalCalories * 0.15; // 15%
                    lunchCals = totalCalories * 0.30; // 30%
                    snack2Cals = totalCalories * 0.15; // 15%
                    dinnerCals = totalCalories * 0.20; // 20%
                } else { // maintain
                    breakfastCals = totalCalories * 0.25;
                    snack1Cals = totalCalories * 0.10;
                    lunchCals = totalCalories * 0.35;
                    snack2Cals = totalCalories * 0.05;
                    dinnerCals = totalCalories * 0.25;
                }

                const selectedBreakfast = getSmartMeal(mealData.breakfast, breakfastCals);
                const selectedSnack1 = getSmartMeal(mealData.snack, snack1Cals);
                const selectedLunch = getSmartMeal(mealData.lunch, lunchCals);
                const selectedSnack2 = getSmartMeal(mealData.snack, snack2Cals);
                const selectedDinner = getSmartMeal(mealData.dinner, dinnerCals);

                const meals = [
                    selectedBreakfast,
                    selectedSnack1,
                    selectedLunch,
                    selectedSnack2,
                    selectedDinner
                ];

                let totalActualCalories = 0;
                let mealListHtml = '';
                meals.forEach(meal => {
                    mealListHtml += `<li>**${meal.name}** (${meal.calories} سعرة حرارية)</li>`;
                    totalActualCalories += meal.calories;
                });

                dietPlanUl.innerHTML = mealListHtml;
                totalMealsCaloriesSpan.textContent = totalActualCalories; // Display total actual calories of selected meals
            }

            /**
             * دالة لتحديث التمارين المقترحة.
             * @param {string} activity - مستوى النشاط البدني للمستخدم.
             * @param {string} goal - هدف المستخدم (lose, maintain, gain).
             * @param {number} height - طول المستخدم بالسنتيمتر.
             * @param {number} age - عمر المستخدم بالسنوات.
             * @param {string} gender - جنس المستخدم ('male' أو 'female').
             */
            function updateExerciseTips(activity, goal, height, age, gender) {
                let cardio, strength, flexibility;
                let heightIncreaseTips = '';

                // معايير الطول التقريبية حسب العمر والجنس (أمثلة تقديرية)
                // هذه الأرقام تقديرية جداً وقد تختلف بشكل كبير
                const averageHeights = {
                    'male': {
                        10: 138, 12: 149, 14: 163, 16: 170, 18: 175, 20: 175, 25: 175
                    },
                    'female': {
                        10: 138, 12: 152, 14: 158, 16: 162, 18: 162, 20: 162, 25: 162
                    }
                };

                // البحث عن متوسط الطول المناسب للعمر
                let avgHeightForAge = 0;
                const ageKeys = Object.keys(averageHeights[gender]).map(Number).sort((a,b) => a-b);
                for (let i = 0; i < ageKeys.length; i++) {
                    if (age <= ageKeys[i]) {
                        avgHeightForAge = averageHeights[gender][ageKeys[i]];
                        break;
                    }
                    if (i === ageKeys.length - 1) { // If age is greater than all keys, use the last one
                        avgHeightForAge = averageHeights[gender][ageKeys[i]];
                    }
                }

                // اقتراح تمارين زيادة الطول إذا كان الطول أقل من المتوسط بشكل ملحوظ (مثلاً 5 سم أقل)
                // ونركز على الأعمار التي لا تزال فيها صفائح النمو نشطة (عادةً قبل 25)
                if (avgHeightForAge > 0 && height < (avgHeightForAge - 5) && age < 25) {
                    heightIncreaseTips = `
                        <li>**تمارين لزيادة الطول (خاصة للأعمار الصغيرة):**
                            <ul>
                                <li>التعلق بالبار: امسك باراً عالياً وعلق جسدك بحرية لمدة 30 ثانية، كرر 3-5 مرات.</li>
                                <li>تمرين الكوبرا: استلقِ على بطنك وارفع الجزء العلوي من جسدك باستخدام ذراعيك، مع إبقاء الوركين على الأرض.</li>
                                <li>تمرين تمديد الساقين: استلقِ على ظهرك وارفع ساق واحدة مستقيمة نحو السقف، ثم بدل الساقين.</li>
                                <li>السباحة: وخاصة سباحة الصدر والظهر، تساعد على إطالة العمود الفقري.</li>
                                <li>اليوجا والبيلاتس: تركز على المرونة وإطالة الجسم.</li>
                            </ul>
                            <span class="text-sm text-red-600">ملاحظة: هذه التمارين قد تساعد في تحسين وضعية الجسم وإطالة العمود الفقري، ولكن زيادة الطول بعد سن البلوغ تعتمد بشكل كبير على العوامل الوراثية وإغلاق صفائح النمو. استشر طبيباً.</span>
                        </li>
                    `;
                }


                if (activity === 'sedentary' || activity === 'light') {
                    cardio = 'ابدأ بالمشي السريع لمدة 20-30 دقيقة، 3-4 مرات في الأسبوع.';
                    strength = 'تمارين وزن الجسم الخفيفة (مثل تمارين الضغط على الحائط، القرفصاء بدون وزن) 2 مرات في الأسبوع.';
                } else if (activity === 'moderate') {
                    cardio = '30-45 دقيقة من الركض أو السباحة أو ركوب الدراجات، 3-5 مرات في الأسبوع.';
                    strength = 'تمارين قوة شاملة للجسم باستخدام الأوزان الخفيفة أو وزن الجسم، 3 مرات في الأسبوع.';
                } else { // active, very_active
                    cardio = '45-60 دقيقة من التمارين الهوائية عالية الشدة (HIIT، ركض مكثف) 4-6 مرات في الأسبوع.';
                    strength = 'تمارين قوة مكثفة (رفع أثقال) 3-4 مرات في الأسبوع مع التركيز على المجموعات العضلية الكبيرة.';
                }

                flexibility = 'تمارين إطالة أو يوجا لمدة 10-15 دقيقة بعد التمارين الرئيسية أو في أيام الراحة.';

                exerciseTipsUl.innerHTML = `
                    <li>**تمارين القلب (Cardio):** ${cardio}</li>
                    <li>**تمارين القوة:** ${strength}</li>
                    <li>**المرونة والإطالة:** ${flexibility}</li>
                    ${heightIncreaseTips}
                `;
            }

            /**
             * دالة لتحديث النصائح العامة.
             */
            function updateGeneralTips() {
                generalTipsUl.innerHTML = `
                    <li>اشرب كميات كافية من الماء (حوالي 8 أكواب يومياً).</li>
                    <li>احصل على قسط كافٍ من النوم (7-9 ساعات يومياً).</li>
                    <li>قلل من تناول السكريات المضافة والأطعمة المصنعة.</li>
                    <li>تناول البروتين في كل وجبة للمساعدة في الشبع والحفاظ على العضلات.</li>
                    <li>استمع إلى جسدك وخذ فترات راحة عند الحاجة.</li>
                    <li>**تتبع التقدم:** قم بتسجيل وزنك ومقاساتك بانتظام لمراقبة تقدمك.</li>
                    <li>**الصبر والمثابرة:** النتائج تستغرق وقتاً، كن صبوراً وملتزماً بخطتك.</li>
                    <li>**استشر متخصصاً:** هذه مجرد اقتراحات عامة، استشر طبيباً أو أخصائي تغذية للحصول على خطة مخصصة لحالتك الصحية.</li>
                `;
            }

            /**
             * دالة لإنشاء محتوى التقرير كنص عادي.
             * @returns {string} - محتوى التقرير كنص عادي.
             */
            function getReportTextContent() {
                const weight = displayWeightSpan.textContent;
                const height = displayHeightSpan.textContent;
                const age = displayAgeSpan.textContent;
                const dailyCalories = dailyCaloriesSpan.textContent;
                const totalMealsCalories = totalMealsCaloriesSpan.textContent; // Get total meals calories
                const isHeightEstimated = !heightEstimateNoteSpan.classList.contains('hidden');
                const genderText = document.querySelector('input[name="gender"]:checked')?.nextElementSibling?.textContent || 'غير محدد';
                const activityLevelText = activityLevelSelect.options[activityLevelSelect.selectedIndex].textContent || 'غير محدد';
                const goalText = document.querySelector('input[name="goal"]:checked')?.nextElementSibling?.textContent || 'غير محدد';
                const notesText = notesInput.value || 'لا توجد ملاحظات إضافية.';

                const dietPlanItems = Array.from(dietPlanUl.children).map(li => li.textContent.replace(/\*\*/g, '')).join('\n- ');
                const exerciseTipsItems = Array.from(exerciseTipsUl.children).map(li => li.textContent.replace(/\*\*/g, '')).join('\n- ');
                const generalTipsItems = Array.from(generalTipsUl.children).map(li => li.textContent.replace(/\*\*/g, '')).join('\n- ');

                const reportDate = new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });

                return `
تقرير لياقة الوزن الشخصي
تاريخ التقرير: ${reportDate}

بياناتك:
- الوزن: ${weight} كجم
- الطول: ${height} سم ${isHeightEstimated ? '(تقديري)' : ''}
- العمر: ${age} سنة
- الجنس: ${genderText}
- مستوى النشاط: ${activityLevelText}
- الهدف: ${goalText}

ملخص الخطة:
السعرات الحرارية المقترحة يومياً: ${dailyCalories} سعرة حرارية
إجمالي سعرات الوجبات المقترحة: ${totalMealsCalories} سعرة حرارية

خطة الوجبات المقترحة:
- ${dietPlanItems}

تمارين مقترحة:
- ${exerciseTipsItems}

نصائح إضافية لنمط حياة صحي:
- ${generalTipsItems}

ملاحظات:
${notesText}

----------------------------------------
هذا التقرير هو لأغراض إرشادية فقط. يرجى استشارة أخصائي صحي أو طبيب للحصول على استشارة شخصية.
تقرير مُولّد بواسطة SMART PPH
                `.trim();
            }

            /**
             * دالة لنسخ محتوى التقرير إلى الحافظة.
             */
            function copyReportToClipboard() {
                if (dailyCaloriesSpan.textContent === '---') {
                    alert('الرجاء حساب السعرات الحرارية والخطة أولاً قبل نسخ التقرير.');
                    return;
                }

                const reportText = getReportTextContent();

                // استخدام document.execCommand('copy') لضمان التوافق مع iframes
                const textArea = document.createElement('textarea');
                textArea.value = reportText;
                textArea.style.position = 'fixed'; // لتجنب التأثير على التخطيط
                textArea.style.opacity = 0; // لجعلها غير مرئية
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    const msg = successful ? 'تم نسخ التقرير إلى الحافظة بنجاح!' : 'فشل نسخ التقرير إلى الحافظة.';
                    alert(msg);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    alert('فشل نسخ التقرير إلى الحافظة. يرجى المحاولة يدوياً.');
                } finally {
                    document.body.removeChild(textArea);
                }
            }


            /**
             * دالة لتوليد وتحميل التقرير كملف Word (HTML-based .doc).
             */
            function generateAndDownloadWordReport() {
                if (dailyCaloriesSpan.textContent === '---') {
                    alert('الرجاء حساب السعرات الحرارية والخطة أولاً قبل توليد التقرير.');
                    return;
                }

                const reportText = getReportTextContent();

                // تحويل النص العادي إلى HTML مناسب لملف Word
                // استبدال الأسطر الجديدة بـ <br> ولف الفقرات في <p>
                const formattedHtmlContent = reportText.split('\n').map(line => {
                    if (line.trim() === '----------------------------------------') {
                        return '<hr style="border-top: 1px dashed #ccc; margin: 15px 0;"/>';
                    }
                    if (line.startsWith('**') && line.endsWith('**')) { // Bold text
                        return `<p style="font-weight: bold; margin-bottom: 5px; font-size: 1.1rem; color: #333; text-align: right;">${line.replace(/\*\*/g, '')}</p>`;
                    }
                    if (line.startsWith('- ')) { // List item
                        return `<li style="margin-right: 1.5rem; font-size: 1.1rem; line-height: 1.6; color: #555; text-align: right;">${line.substring(2)}</li>`;
                    }
                    if (line.trim().endsWith(':')) { // Section titles
                        return `<h3 style="font-weight: bold; font-size: 1.25rem; margin-bottom: 0.75rem; color: #333; margin-top: 1.5rem; text-align: right;">${line}</h3>`;
                    }
                    return `<p style="margin-bottom: 5px; font-size: 1.1rem; line-height: 1.6; color: #555; text-align: right;">${line}</p>`;
                }).join('');

                const wordHtmlContent = `
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body {
                                font-family: 'Cairo', sans-serif;
                                direction: rtl;
                                padding: 20mm;
                                color: #333;
                                line-height: 1.6;
                            }
                            h1, h2, h3 {
                                color: #333;
                                text-align: center;
                                margin-bottom: 1rem;
                            }
                            ul {
                                list-style-type: disc;
                                margin-right: 20px;
                            }
                            li {
                                margin-bottom: 5px;
                            }
                            hr {
                                border-top: 1px dashed #ccc;
                                margin: 15px 0;
                            }
                            p {
                                margin-bottom: 5px;
                            }
                        </style>
                    </head>
                    <body>
                        ${formattedHtmlContent}
                        <div style="margin-top: 2.5rem; text-align: center; color: #777; font-size: 0.85rem;">
                            <p>هذا التقرير هو لأغراض إرشادية فقط. يرجى استشارة أخصائي صحي أو طبيب للحصول على استشارة شخصية.</p>
                            <p>تقرير مُولّد بواسطة SMART PPH</p>
                        </div>
                    </body>
                    </html>
                `;

                const blob = new Blob([wordHtmlContent], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'تقرير_لياقة_الوزن_SMART_PPH.doc'; // Use .doc extension
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // قاعدة بيانات الأكل (يمكن توسيعها)
            const foodDatabase = [
                { name: 'تفاح (1 متوسطة)', calories: 95 },
                { name: 'موز (1 متوسطة)', calories: 105 },
                { name: 'صدر دجاج مشوي (100 جرام)', calories: 165 },
                { name: 'أرز أسمر مطبوخ (1 كوب)', calories: 215 },
                { name: 'بيض مسلوق (1 بيضة كبيرة)', calories: 78 },
                { name: 'زبادي يوناني قليل الدسم (1 كوب)', calories: 150 },
                { name: 'لوز (28 جرام / حوالي 23 حبة)', calories: 160 },
                { name: 'خبز أسمر (1 شريحة)', calories: 80 },
                { name: 'زيت زيتون (1 ملعقة كبيرة)', calories: 120 },
                { name: 'حمص (100 جرام)', calories: 164 },
                { name: 'عدس مطبوخ (1 كوب)', calories: 230 },
                { name: 'سمك سلمون مشوي (100 جرام)', calories: 208 },
                { name: 'بطاطا حلوة (1 متوسطة)', calories: 112 },
                { name: 'بروكلي مطبوخ (1 كوب)', calories: 55 },
                { name: 'سلطة خضراء (كوب كبير)', calories: 50 },
                { name: 'حليب قليل الدسم (1 كوب)', calories: 100 },
                { name: 'شوفان (نصف كوب جاف)', calories: 150 },
                { name: 'توت (1 كوب)', calories: 80 },
                { name: 'بذور الشيا (2 ملعقة كبيرة)', calories: 140 },
                { name: 'أفوكادو (نصف حبة)', calories: 160 },
                { name: 'جبنة قريش (نصف كوب)', calories: 120 }
            ];

            /**
             * دالة لفتح مودال قاعدة بيانات الأكل.
             */
            function openFoodDatabaseModal() {
                foodDatabaseList.innerHTML = ''; // Clear previous content
                foodDatabase.sort((a, b) => a.name.localeCompare(b.name, 'ar')); // Sort alphabetically
                foodDatabase.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${item.name}</span><span>${item.calories} سعرة حرارية</span>`;
                    foodDatabaseList.appendChild(listItem);
                });

                foodDatabaseModal.classList.remove('hidden');
                void foodDatabaseModal.offsetWidth; // Force reflow
                foodDatabaseModal.classList.add('visible');
            }

            /**
             * دالة لإغلاق مودال قاعدة بيانات الأكل.
             */
            window.closeFoodDatabaseModal = function() {
                foodDatabaseModal.classList.remove('visible');
                foodDatabaseModal.addEventListener('transitionend', function handler() {
                    foodDatabaseModal.classList.add('hidden');
                    foodDatabaseModal.removeEventListener('transitionend', handler);
                });
            };

            /**
             * دالة لإنشاء محتوى إيصال لياقة الوزن كـ HTML.
             * هذه الدالة لا تطبع مباشرة، بل تُرجع المحتوى.
             */
            function generateFitnessReceiptHtml() {
                // التأكد من حساب وعرض النتائج قبل توليد المحتوى
                if (dailyCaloriesSpan.textContent === '---') {
                    alert('الرجاء حساب السعرات الحرارية والخطة أولاً قبل طباعة الإيصال.');
                    return '';
                }

                const weight = displayWeightSpan.textContent;
                const age = displayAgeSpan.textContent;
                const height = displayHeightSpan.textContent;
                const dailyCalories = dailyCaloriesSpan.textContent;
                const isHeightEstimated = !heightEstimateNoteSpan.classList.contains('hidden');
                const notesText = notesInput.value || 'لا توجد ملاحظات'; // الحصول على الملاحظات من حقل الإدخال

                // الحصول على التاريخ والوقت الحاليين
                const now = new Date();
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                const formattedDate = now.toLocaleDateString('ar-EG', dateOptions);
                const formattedTime = now.toLocaleTimeString('ar-EG', timeOptions);

                // الحصول على محتوى خطة الوجبات بشكل مبسط جداً (فقط أسماء الوجبات)
                // تم تعديل هذا الجزء ليكون مختصرًا جدًا
                const dietPlanSimple = Array.from(dietPlanUl.children).map(li => {
                    // استخراج اسم الوجبة فقط، إزالة السعرات الحرارية وما إلى ذلك
                    const match = li.textContent.match(/\*\*(.*?)\*\*/);
                    return match ? match[1].trim() : li.textContent.trim();
                }).join('\n');

                // بناء محتوى HTML للإيصال
                return `
                    <div class="receipt-container" style="text-align: center;">
                        ${pharmacyData.logoUrl && !pharmacyData.logoUrl.includes('placehold.co') ? `<img src="${pharmacyData.logoUrl}" alt="Pharmacy Logo" class="logo-placeholder" onerror="this.style.display='none';">` : ''}
                        <h1 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">${pharmacyData.name || 'اسم الصيدلية'}</h1>
                        <p style="font-size: 0.8rem; margin-bottom: 5px;">${pharmacyData.address || 'عنوان الصيدلية'}</p>
                        <p style="font-size: 0.8rem; margin-bottom: 10px;">${pharmacyData.phone || 'رقم الهاتف'}</p>

                        <div class="divider"></div>

                        <h2 style="font-size: 1rem; font-weight: bold; margin-bottom: 10px;">إيصال لياقة الوزن</h2>
                        <p style="font-size: 0.9rem; margin-bottom: 5px; text-align: right;">التاريخ: ${formattedDate}</p>
                        <p style="font-size: 0.9rem; margin-bottom: 15px; text-align: right;">الوقت: ${formattedTime}</p>

                        <div style="text-align: right; margin-bottom: 15px;">
                            <p style="font-size: 1rem; margin-bottom: 5px;"><span style="font-weight: bold;">الوزن:</span> ${weight} كجم</p>
                            <p style="font-size: 1rem; margin-bottom: 5px;"><span style="font-weight: bold;">الطول:</span> ${height} سم ${isHeightEstimated ? '(تقديري)' : ''}</p>
                            <p style="font-size: 1.1rem; margin-top: 10px;"><span style="font-weight: bold;">السعرات الحرارية المقترحة:</span> ${dailyCalories} سعرة حرارية</p>
                        </div>

                        <div class="divider"></div>

                        <h3 style="font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; text-align: right;">خطة الوجبات:</h3>
                        <pre style="font-size: 0.9rem; text-align: right; white-space: pre-wrap; word-wrap: break-word;">${dietPlanSimple}</pre>

                        <div class="divider"></div>

                        <p style="font-size: 0.8rem; margin-top: 10px; text-align: center;">للمزيد اطلب ارسال تقرير الشامل لك علي هاتفك</p>
                        <p style="font-size: 0.7rem; margin-top: 5px;">شكراً لاستخدامك SMART PPH</p>
                       
                    </div>
                `;
            }

            /**
             * دالة لفتح مودال معاينة إيصال لياقة الوزن.
             */
            function openFitnessReceiptPreviewModal() {
                const receiptHtml = generateFitnessReceiptHtml();
                if (receiptHtml) {
                    modalFitnessReceiptContent.innerHTML = receiptHtml;
                    fitnessReceiptPreviewModal.classList.remove('hidden');
                    void fitnessReceiptPreviewModal.offsetWidth; // Force reflow
                    fitnessReceiptPreviewModal.classList.add('visible');
                }
            }

            /**
             * دالة لطباعة المحتوى من نافذة المعاينة.
             * @param {string} contentElementId - معرف العنصر الذي يحتوي على المحتوى المراد طباعته.
             * @param {boolean} isCopy - لتحديد ما إذا كانت نسخة (يضيف "نسخة" إلى الإيصال).
             */
            window.printContent = function(contentElementId, isCopy = false) {
                const contentToPrint = document.getElementById(contentElementId).cloneNode(true);
                
                // إزالة أي عناصر تفاعلية أو أزرار من المحتوى المستنسخ قبل الطباعة
                const interactiveElements = contentToPrint.querySelectorAll('button, input, select, textarea');
                interactiveElements.forEach(element => element.remove());

                // إضافة نص "نسخة" إذا كانت نسخة
                if (isCopy) {
                    const copyTextDiv = document.createElement('p');
                    copyTextDiv.textContent = 'نسخة';
                    copyTextDiv.style.textAlign = 'center';
                    copyTextDiv.style.fontWeight = 'bold';
                    copyTextDiv.style.marginTop = '10px';
                    contentToPrint.appendChild(copyTextDiv);
                }

                const printFrame = document.createElement('iframe');
                printFrame.style.display = 'none';
                document.body.appendChild(printFrame);
                const printDocument = printFrame.contentWindow.document;

                printDocument.open();
                printDocument.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>إيصال لياقة الوزن</title>
                        <link rel="preconnect" href="https://fonts.googleapis.com">
                        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                        <style>
                            /* Global print styles to ensure clean receipt */
                            body {
                                font-family: 'Cairo', sans-serif;
                                margin: 0;
                                padding: 0;
                                direction: rtl;
                                color: #000;
                                background-color: #fff;
                            }
                            .receipt-container {
                                width: 72mm; /* Thermal printer width */
                                padding: 4mm;
                                box-sizing: border-box;
                                margin: 0 auto; /* Center for A4 print preview */
                            }
                            .receipt-container h1, .receipt-container h2, .receipt-container h3, .receipt-container p, .receipt-container span, .receipt-container label {
                                color: #000 !important;
                                font-weight: normal; /* Reset font-weight */
                            }
                            .receipt-container h1 { font-weight: bold !important; font-size: 1.2rem; }
                            .receipt-container h2 { font-weight: bold !important; font-size: 1rem; }
                            .receipt-container h3 { font-weight: bold !important; font-size: 0.9rem; }
                            .receipt-container .logo-placeholder {
                                max-width: 50mm; /* Adjust logo size for receipt */
                                height: auto;
                                display: block;
                                margin: 0 auto 5mm;
                            }
                            .receipt-container .divider {
                                border-top: 1px dashed #000;
                                margin: 5mm 0;
                            }
                            /* Hide textarea border in print */
                            .receipt-container textarea {
                                border: none !important;
                                resize: none;
                                width: 100%;
                                min-height: 30mm;
                                font-family: 'Cairo', sans-serif;
                                color: #000;
                                text-align: right;
                                padding: 0 !important;
                                box-sizing: border-box;
                            }
                            /* Style for preformatted text in print */
                            .receipt-container pre {
                                border: none !important;
                                background-color: transparent !important;
                                padding: 0 !important;
                                margin: 0 !important;
                                font-size: 0.9rem;
                                text-align: right;
                                white-space: pre-wrap;
                                word-wrap: break-word;
                            }
                        </style>
                    </head>
                    <body>
                        ${contentToPrint.outerHTML}
                    </body>
                    </html>
                `);
                printDocument.close();

                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
                document.body.removeChild(printFrame); // Clean up the iframe
            };

            /**
             * دالة لطباعة إيصال لياقة الوزن من المودال.
             */
            window.printFitnessReceiptFromModal = function() {
                window.printContent('modalFitnessReceiptContent');
                window.closeFitnessReceiptPreviewModal();
            };

            /**
             * دالة لإغلاق مودال معاينة إيصال لياقة الوزن.
             */
            window.closeFitnessReceiptPreviewModal = function() {
                fitnessReceiptPreviewModal.classList.remove('visible');
                fitnessReceiptPreviewModal.addEventListener('transitionend', function handler() {
                    fitnessReceiptPreviewModal.classList.add('hidden');
                    fitnessReceiptPreviewModal.removeEventListener('transitionend', handler);
                });
                modalFitnessReceiptContent.innerHTML = ''; // Clear content when closing
            };
        });
        


    const floatingButton = document.getElementById('floatingButton');
    const floatingButtonIcon = document.getElementById('floatingButtonIcon');
    const floatingButtonText = document.querySelector('.floating-button-text');
    const faceOverlay = document.getElementById('faceOverlay');

    let animationInProgress = false; // Flag to prevent animation re-triggering

    // Function to reset all animations and hide the face
    function resetAnimationState() {
        floatingButtonIcon.classList.remove('jump-animation', 'glow-animation');
        floatingButtonIcon.style.filter = ''; // Remove brightness filter
        faceOverlay.classList.remove('visible', 'face-appear', 'face-smile', 'face-wave', 'face-disappear');
        // Ensure star and text are visible again
        floatingButtonIcon.style.opacity = '1';
        floatingButtonText.style.opacity = '1';
        animationInProgress = false; // Reset flag after animation sequence completes
    }

    // Function to trigger the full animation sequence
    function triggerAnimation() {
        if (animationInProgress) return; // Exit if an animation is already running
        animationInProgress = true;

        // 1. Star Jump (3 times)
        floatingButtonIcon.classList.add('jump-animation');

        // Use a Promise to sequence animations for cleaner code
        const animateStarJump = new Promise(resolve => {
            const handleJumpEnd = (event) => {
                if (event.animationName === 'starJump') {
                    floatingButtonIcon.removeEventListener('animationend', handleJumpEnd);
                    resolve();
                }
            };
            floatingButtonIcon.addEventListener('animationend', handleJumpEnd);
        });

        animateStarJump.then(() => {
            // 2. Star Glow
            floatingButtonIcon.classList.remove('jump-animation');
            floatingButtonIcon.classList.add('glow-animation');

            return new Promise(resolve => {
                const handleGlowEnd = (event) => {
                    if (event.animationName === 'starGlow') {
                        floatingButtonIcon.removeEventListener('animationend', handleGlowEnd);
                        resolve();
                    }
                };
                floatingButtonIcon.addEventListener('animationend', handleGlowEnd);
            });
        }).then(() => {
            // Hide star and text, show face
            floatingButtonIcon.style.opacity = '0';
            floatingButtonText.style.opacity = '0';
            
            // 3. Face Appear
            faceOverlay.classList.add('visible', 'face-appear');

            return new Promise(resolve => {
                const handleFaceAppearEnd = (event) => {
                    if (event.animationName === 'faceAppear') {
                        faceOverlay.removeEventListener('animationend', handleFaceAppearEnd);
                        resolve();
                    }
                };
                faceOverlay.addEventListener('animationend', handleFaceAppearEnd);
            });
        }).then(() => {
            // 4. Face Smile (briefly)
            faceOverlay.classList.add('face-smile');

            return new Promise(resolve => {
                const handleFaceSmileEnd = (event) => {
                    if (event.animationName === 'faceSmile') {
                        faceOverlay.removeEventListener('animationend', handleFaceSmileEnd);
                        faceOverlay.classList.remove('face-smile'); // Remove smile class after animation
                        resolve();
                    }
                };
                faceOverlay.addEventListener('animationend', handleFaceSmileEnd);
            });
        }).then(() => {
            // 5. Face Wave
            faceOverlay.classList.add('face-wave');

            return new Promise(resolve => {
                const handleFaceWaveEnd = (event) => {
                    if (event.animationName === 'faceWave') {
                        faceOverlay.removeEventListener('animationend', handleFaceWaveEnd);
                        resolve();
                    }
                };
                faceOverlay.addEventListener('animationend', handleFaceWaveEnd);
            });
        }).then(() => {
            // 6. Face Disappear
            faceOverlay.classList.add('face-disappear');

            return new Promise(resolve => {
                const handleFaceDisappearEnd = (event) => {
                    if (event.animationName === 'faceDisappear') {
                        faceOverlay.removeEventListener('animationend', handleFaceDisappearEnd);
                        resolve();
                    }
                };
                faceOverlay.addEventListener('animationend', handleFaceDisappearEnd);
            });
        }).then(() => {
            // All animations complete, reset state
            resetAnimationState();
        }).catch(error => {
            console.error("Animation sequence error:", error);
            resetAnimationState(); // Ensure state is reset even on error
        });
    }

    // Trigger animation on mouse enter
    floatingButton.addEventListener('mouseenter', triggerAnimation);

    // Trigger animation automatically every 45 seconds
    setInterval(triggerAnimation, 45000); // 45000 milliseconds = 45 seconds


    </script>
    
</body<script>
    /**
     * يستمع إلى حدث "offline" ويعيد توجيه المستخدم إلى صفحة offline.html.
     * هذا يضمن أن يتم عرض صفحة انقطاع الاتصال تلقائيًا دون الحاجة لإعادة تحميل يدوية.
     */
    window.addEventListener('offline', () => {
        console.log("Internet connection lost! Redirecting to offline page.");
        window.location.href = 'offline.html';
    });
</script>
>
</html>

